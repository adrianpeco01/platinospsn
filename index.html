<!DOCTYPE html>
<html lang="en" class="light" style="color-scheme: light;"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><link rel="preload" href="https://platinumhunt.com/_next/static/media/04ff47e1ca568747-s.p.woff2" as="font" crossorigin="" type="font/woff2"><link rel="stylesheet" href="./adricollantex • Platinum Hunt MARZO 2025_files/6a6e97510208f44d.css" data-precedence="next"><link rel="preload" as="script" fetchpriority="low" href="https://platinumhunt.com/_next/static/chunks/webpack-c1bcd6ec2f134d68.js"><link rel="preload" href="./adricollantex • Platinum Hunt MARZO 2025_files/A2103_xl.png" as="image" fetchpriority="high"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Mi colección de videojuegos</title><meta name="description" content="Mi colección de videojuegos"><meta property="og:title" content="adricollantex"><meta property="og:description" content="Mi colección de videojuegos"><meta property="og:url" content="https://platinumhunt.com"><meta property="og:site_name" content="Platinum Hunt"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://static-resource.np.community.playstation.net/avatar_xl/WWS_A/A2103_xl.png"><meta property="og:type" content="website"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="adricollantex"><meta name="twitter:description" content="Mi colección de videojuegos"><meta name="twitter:image" content="http://static-resource.np.community.playstation.net/avatar_xl/WWS_A/A2103_xl.png"><link rel="icon" href="./adricollantex • Platinum Hunt MARZO 2025_files/favicon.ico" type="image/x-icon" sizes="48x48"><link rel="icon" href="./adricollantex • Platinum Hunt MARZO 2025_files/favicon.ico" type="image/svg+xml" sizes="any"><link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet"><link rel="apple-touch-icon" href="./adricollantex • Platinum Hunt MARZO 2025_files/favicon.ico" type="image/png" sizes="180x180"><meta name="next-size-adjust"><!-- Tailwind safelist --> <div class="hidden opacity-0 opacity-100 pointer-events-none pointer-events-auto"></div>

<style>

  @font-face {
    font-family: 'Monofonto';
    src: url('./adricollantex • Platinum Hunt MARZO 2025_files/Coolvetica Rg.otf') format('truetype'); /* Ajusta la ruta y el formato según tu archivo */
    /* Puedes añadir más bloques @font-face para diferentes pesos (bold, italic, etc.) si la fuente los tiene */
    font-weight: normal;
    font-style: normal;
  }

.sm\:block.__className_9fd9c5,
.sm\:hidden.__className_9fd9c5 {
  /* Usa 'Orbitron' directamente, ya que el @import de Google Fonts la define así */
  font-family: 'Orbitron', sans-serif; 

  /* Asegúrate de que el font-weight sea 700 */
  font-weight: 700 !important; 
}

#modal, #modal * {
  font-family: 'Inter', sans-serif;
}

  #loginModal {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(6px);
  z-index: 50;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease-in-out;
}

#loginModal.opacity-100 {
  opacity: 1;
  pointer-events: auto;
}

#loginBox {
  background-color: white;
  border-radius: 0.75rem; /* 8px */
  padding: 1.5rem; /* 24px */
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  max-width: 400px;
  width: 90%;
  opacity: 0;
  transform: scale(0.95);
  transition: opacity 0.3s ease, transform 0.3s ease;
}

#loginBox.opacity-100 {
  opacity: 1;
  transform: scale(1);
}
#loginSubmit {
  width: 100%;                  /* w-full */
  background-color: #2563eb;    /* bg-blue-600 */
  color: white;                 /* text-white */
  padding-top: 0.5rem;          /* py-2 */
  padding-bottom: 0.5rem;
  border-radius: 0.25rem;       /* rounded */
  border: none;
  cursor: pointer;
}

#loginSubmit:hover {
  background-color: #1557e6; /* Azul más fuerte al hacer hover */
}

.login-error input,
.login-error #loginSubmit {
  border-color: red !important;
  background-color: #fee2e2 !important;
  color: red !important;
}

.login-error #logoutButton {
  color: red !important;
  background-color: transparent !important;
  border: none !important;
}

#plus.active {
  background-color: #f1f5f9;
  color: var(--accent-foreground); /* o ajusta el color del texto si quieres */
}

/* Estado oculto */
#toggleForm, #authStatus {
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease-in-out;
}

/* Estado visible */
#toggleForm.visible, #authStatus.visible {
  opacity: 1;
  pointer-events: auto;
}

.container {
  display: flex;
  gap: 1.5rem; /* ajusta como quieras */
}

#loginTooltip {
  position: absolute;
  margin-top: 0.5rem;
  padding: 0;
  width: 260px;
  z-index: 50;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;

  /* Fondo suave rojizo */
  background-color: #fee2e2; /* más claro que #fecaca */
  border: 1px solid #fca5a5;
  border-radius: 0.75rem;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

#loginTooltip.visible {
  opacity: 1;
  visibility: visible;
}

#loginTooltip > div {
  padding: 0.5rem 1rem 0.2rem 1rem;
  margin: 0;
   white-space: normal;
   color: #7f1d2f; /* rojo más intenso y legible */
}

#loginTooltip .arrow {
  position: absolute;
  top: -6px;
  right: auto;
  width: 12px;
  height: 12px;
  background: #fee2e2; /* mismo color que fondo */
  border-top: 1px solid #fca5a5;
  border-right: 1px solid #fca5a5;
  transform: rotate(-45deg);
  box-shadow: 1px -1px 0 #fca5a5;
}

@keyframes fade-in {
  from { opacity: 0; transform: translateY(-5px); }
  to { opacity: 1; transform: translateY(0); }
}
.animate-fade-in {
  animation: fade-in 0.3s ease-out;
}

#modalOverlay.flex {
  display: flex !important;
}

#modalOverlay.opacity-100 {
  opacity: 1;
  pointer-events: auto;
  display: flex; /* Asegúrate de agregar esto */
}

#gameForm.opacity-100 {
  opacity: 1;
  transform: scale(1);
  pointer-events: auto;
}

#gameForm {
  background-color: white;
  border-radius: 0.75rem; /* 12px */
  padding: 1.5rem;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  max-width: 700px;
  width: 90%;
  opacity: 0;
  transform: scale(0.95);
  pointer-events: none;
  transition: opacity 0.3s ease, transform 0.3s ease;

   /* Nuevas propiedades */
  max-height: 80vh; /* Ajusta este valor según tus necesidades */
  overflow-y: auto; /* 'auto' muestra la barra solo cuando es necesario, 'scroll' la muestra siempre */
}

#gameForm.visible {
  opacity: 1;
  transform: scale(1);
  pointer-events: auto;
}

#gameForm.opacity-100 {
  transform: scale(1);
  opacity: 1;
}

#modalOverlay {
  position: fixed;
  inset: 0;
  display: none; /* Cambia 'flex' por 'none' */
  align-items: center;
  justify-content: center;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(6px);
  z-index: 999;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease-in-out;
}

#modalOverlay.visible {
  opacity: 1;
  pointer-events: auto;
  display: flex;  /* necesario para que se muestre */
}
.form-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 1rem;
}

.form-row-2 {
  display: grid;
  grid-template-columns: 1fr;
  gap: 1rem;
}

.form-row-3 {
  display: grid;
  grid-template-columns: 1fr;
  gap: 1rem;
}

.form-item {
  display: grid; /* Usamos Grid Layout */
  grid-template-columns: 2em 1fr; /* Dos columnas: emoji y campo */
  grid-template-rows: auto; /* Ajuste automático de altura */
  align-items: center; /* Centrar verticalmente */
  gap: 0.5rem;
}

.form-emoji {
  grid-column: 1;
  grid-row: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2em;
  height: 100%; /* Asegura que el emoji ocupe toda la altura */
}

.form-input {
  grid-column: 2;
  grid-row: 1;
  border: 1px solid #ccc;
  padding: 0.5rem;
  border-radius: 0.25rem;
  width: 100%;
}

.form-item.w-full {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 2em 1fr;
}

/* Media query para pantallas más grandes */
@media (min-width: 768px) {
  .form-row-2 {
    grid-template-columns: repeat(2, 1fr);
  }

  .form-row-3 {
    grid-template-columns: repeat(3, 1fr);
  }
}
select#platform,
select#folder,
select#condition,
select#edition {
  color: #9ca3af; /* Color gris por defecto */
}

select#platform:valid,
select#platform:not(:invalid),
select#folder:valid,
select#folder:not(:invalid),
select#condition:valid,
select#condition:not(:invalid),
select#edition:valid,
select#edition:not(:invalid) {
  color: black; /* Color negro cuando hay valor seleccionado */
}

select#platform option:first-of-type,
select#folder option:first-of-type,
select#condition option:first-of-type,
select#edition option:first-of-type {
  color: #9ca3af; /* Asegurar gris en placeholder (redundante pero seguro) */
}

select#platform option:not(:first-of-type),
select#folder option:not(:first-of-type),
select#condition option:not(:first-of-type),
select#edition option:not(:first-of-type) {
  color: black; /* Asegurar negro en opciones (redundante pero seguro) */
}
#estadoStarsContainer {
  cursor: pointer;
}

#estadoStars span {
  transition: color 0.2s; /* Suavizar el cambio de color */
}

#estadoStars span.active {
  color: gold; /* Color de las estrellas activas */
}

#guardarSubmit {
  width: 100%;         /* w-full */
  background-color: #2563eb;   /* bg-blue-600 */
  color: white;         /* text-white */
  padding-top: 0.5rem;     /* py-2 */
  padding-bottom: 0.5rem;
  border-radius: 0.25rem;   /* rounded */
  border: none;
  cursor: pointer;
}

#guardarSubmit:hover {
  background-color: #1557e6; /* Azul más fuerte al hacer hover */
}

#modal {
  display: none; /* oculto por defecto */
  position: fixed;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  justify-content: center;
  align-items: center;
  z-index: 50;
  opacity: 0;
  pointer-events: none;
  transition: opacity 300ms ease-in-out;
}

#modal.flex { /* Usamos .flex en lugar de .show para la visibilidad */
  display: flex;
  opacity: 1;
  pointer-events: auto;
}

#modal > div {
  background: white;
  border-radius: 1rem;
  max-width: 520px; /* Ajustado al max-width de tu HTML */
  min-width: 300px; /* Ajustado al min-width de tu HTML */
  width: 80%;
  padding: 1.5rem;
  position: relative;
  transform: scale(0.95);
  opacity: 0;
  transition: transform 300ms ease, opacity 300ms ease;
  will-change: transform, opacity;
  max-height: 90vh;         /* No sobrepasar el 90% de la ventana */
  overflow-y: auto; /* Habilita scroll si el contenido es muy alto */
  overscroll-behavior: contain; /* ¡Añade esta línea! */
  scrollbar-width: thin;
  scrollbar-color: #ccc transparent;
}

/* Scrollbar estilos comunes */
#modal > div::-webkit-scrollbar {
  width: 8px;
}

#modal > div::-webkit-scrollbar-track {
  background: transparent;
  border-radius: 1rem;
}

#modal > div::-webkit-scrollbar-thumb {
  background-color: #ccc;
  border-radius: 1rem;
}

#modal.flex > div { /* Usamos .flex aquí también */
  transform: scale(1);
  opacity: 1;
}

@media (max-width: 480px) {
  #modal > div {
    width: 95%;
    max-height: 85vh;
    overflow-y: scroll; /* Permitir scroll vertical */
    -ms-overflow-style: none;  /* IE y Edge */
    scrollbar-width: none;     /* Firefox */
  }

  /* Ocultar scrollbar en WebKit (Chrome, Safari, Opera) */
  #modal > div::-webkit-scrollbar {
    display: none;
  }

  #modal > div::-webkit-scrollbar-track {
    background: transparent !important;
  }

  #modal > div::-webkit-scrollbar-thumb {
    background: transparent !important;
  }
}

body.modal-open { /* Usa la clase que apliques al body cuando el modal está activo */
  overflow: hidden; /* Mantén esto para evitar el scroll */
  position: fixed; /* Fija el body en la ventana */
  width: 100%; /* Asegura que ocupe todo el ancho */
  /* El 'top' se establecerá con JavaScript */
}

.custom-scroll {
  max-height: 80vh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch; /* necesario para iOS */
}


.body-no-scroll {
  overflow: hidden;
  width: 100%;
  height: 100%;
  top: 0;
  left: 0;
}

  /* Evita el scroll en el modal por fallback */
html.no-scroll,
body.no-scroll {
  overflow: hidden;
  overscroll-behavior: none;
  touch-action: none;
}


#modal h3 {
  font-size: 1rem;
  margin-bottom: 0.5rem;
}

.zoom-image {
  position: fixed;
  z-index: 9999;
  border-radius: 0.5rem;
  transition: transform 0.5s ease, top 0.5s ease, left 0.5s ease, width 0.5s ease, height 0.5s ease;
  will-change: transform, top, left, width, height;
  cursor: default;
  object-fit: cover;
}

#closeModalBtn {
  position: absolute;
  top: 0.5rem;         /* 8px */
  right: 0.75rem;      /* 12px */
  font-size: 0.875rem; /* text-sm */
  font-weight: 600;
  color: #e8e9eb;
  z-index: 100;
  background: transparent;
  border: none;
  cursor: pointer;
  transition: color 200ms ease;
}

#closeModalBtn:hover {
  color: #b2b4b6;
}


/* Estilos personalizados para el modal */
.custom-bg-gray { background-color: #f9fafa; }
.custom-bg-blue-50 { background-color: #eff6ff; }
.custom-text-gray-500 { color: #6b7280; }
.custom-text-gray-700 { color: #5d636e; }
.custom-text-gray-800 { color: #323233; }
.custom-text-green-600 { color: #47b46f; }
.custom-text-green-700 { color: #16a34a; }
.custom-text-blue-800 { color: #1e40af; }
.custom-text-red-500 { color: #bb1212; }
.custom-text-blue-500 { color: #814646; }

.custom-p-6 { padding: 1.5rem; }
.custom-p-4 { padding: 1rem; }
.custom-mt-6 { margin-top: 1.5rem; }
.custom-mb-4 { margin-bottom: 1rem; }
.custom-mb-6 { margin-bottom: 1.5rem; }
.custom-mt-2 { margin-top: 0.5rem; }

.custom-rounded-lg { border-radius: 0.5rem; }
.custom-shadow-inner { box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06); }

.custom-flex { display: flex; }
.custom-flex-col { flex-direction: column; }
.custom-items-center { align-items: center; }
.custom-items-start { align-items: flex-start; }
.custom-justify-center { justify-content: center; }
.custom-w-full { width: 100%; }
.custom-gap-4 { gap: 1rem; }
.custom-flex-wrap { flex-wrap: wrap; }

.custom-text-2xl { font-size: 1.5rem; }
.custom-text-xl { font-size: 1.25rem; }
.custom-text-lg { font-size: 1.125rem; }
.custom-text-sm { font-size: 0.875rem; }
.custom-font-bold { font-weight: 700; }
.custom-font-semibold { font-weight: 600; }
.custom-leading-relaxed { line-height: 1.625; }
.custom-text-center { text-align: center; }

/* Estilos para la rejilla de detalles */
.custom-grid-md-2 {
  display: grid;
  grid-template-columns: 1fr;
  gap: 1.5rem;
  margin-bottom: 1.5rem;
}

@media (min-width: 768px) {
  .custom-grid-md-2 {
    grid-template-columns: repeat(2, 1fr);
  }
}

.custom-pr-4 {
  padding-right: 1rem;
}

.condition-span {
  white-space: nowrap; /* Evita el salto de línea */
}

.estado-span {
  margin-left: 0.25em; /* Espacio antes del estado */
  white-space: nowrap; /* Evita el salto de línea */
}

.custom-text-gray-800 {
  color: #273242; /* Equivalente al text-gray-800 de Tailwind */
}

.custom-icon-shadow {
  filter: drop-shadow(0 0 5px rgba(0, 0, 0, 0.3));
}

#svg-hablando {
  position: relative;
  left: 7px;  /* desplaza a la derecha 10px */
  top: -3px;    /* desplaza hacia abajo 5px */
}

/* 👇 Clase que bloquea el scroll sin romper sticky */
.scroll-lock {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  overflow-y: scroll;
  overscroll-behavior: none;
  touch-action: none;
}


html {
  overflow-y: scroll;
}

/* Estilos para el overlay de la imagen en pantalla completa */
.fullscreen-image-modal {
  /* Propiedades para el estado oculto inicial */
  display: flex; /* Mantenemos 'flex' para que las animaciones funcionen */
  visibility: hidden; /* Oculto visualmente por defecto */
  opacity: 0; /* Opacidad inicial para la animación de entrada */
  pointer-events: none; /* Evita que bloquee clics cuando está oculto */
  transition: opacity 300ms ease-in-out, visibility 300ms ease-in-out; /* Transiciones suaves para opacidad y visibilidad */

  /* Propiedades fijas del modal (siempre presentes, afectando el contenedor) */
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9); /* Fondo oscuro semitransparente */
  justify-content: center; /* Centra horizontalmente la imagen */
  align-items: center; /* Centra verticalmente la imagen */
  z-index: 100; /* Asegúrate de que esté por encima de tu modal principal */
}

/* Estado activo del modal (cuando se muestra) */
.fullscreen-image-modal.active {
  visibility: visible; /* Hace el modal visible */
  opacity: 1; /* Opacidad final para mostrar */
  pointer-events: auto; /* Permite clics cuando está visible */
}

/* Estilos para la imagen dentro del overlay */
.fullscreen-image {
  /* ¡CAMBIO CRÍTICO AQUÍ! */
  max-height: 90vh; /* Permite que la imagen NO exceda el 90% del alto del viewport, pero se ajuste si es necesario */
  height: auto; /* Asegura que la altura se ajuste automáticamente para mantener la relación de aspecto */
  
  width: auto; /* Mantiene la relación de aspecto del ancho */
  max-width: 90%; /* Asegura que no desborde horizontalmente si el ancho ajustado es demasiado grande */
  object-fit: contain; /* Asegura que la imagen se ajuste sin recortarse */
  border-radius: 0.3rem; /* El redondez específico de 0.3rem. Ahora debería ser visible. */
  
  /* Propiedades de animación */
  transform: scale(0.8); /* Estado inicial para el zoom-in */
  transition: transform 300ms ease-out; /* Animación de transformación a 300ms */
}

/* Estado de la imagen cuando el modal está activo (para el zoom-in) */
.fullscreen-image-modal.active .fullscreen-image {
  transform: scale(1); /* Estado final para el zoom-in */
}

#sort-menu {
  width: 11rem; /* o 10.5rem */
}

.chart-container {
            width: 100%;
            height: 250px; /* Approximate height based on image */
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            background-color: #f9f9f9;
            /* In a real scenario, this would be a canvas or SVG for the chart */
        }
        .chart-placeholder {
            /* This will be replaced by a JS chart (e.g., Chart.js, D3.js) */
            text-align: center;
            padding: 20px;
        }
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #555;
        }
        .legend-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
            border: 1px solid #666; /* Circle border */
            box-sizing: border-box;
            background-color: transparent; /* Default for hollow circle */
        }
        /* Specific colors for filled circles based on the image's legend */
        .legend-icon.valor { background-color: #333; border-color: #333;}
        .legend-icon.contar { border-color: #333; } /* Hollow */
        .legend-icon.costo { border-color: #333; } /* Hollow */
        .legend-icon.ganancia { border-color: #333; } /* Hollow */


        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden; /* Ensures border-radius applies to rows */
        }
        .summary-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            font-size: 16px;
        }
        .summary-table tr:last-child td {
            border-bottom: none;
        }
        .summary-table td:first-child {
            color: #555;
            font-weight: normal;
        }
        .summary-table td:last-child {
            text-align: right;
            font-weight: bold;
            color: #333;
        }
        /* Specific styling for the 'Valor' row to match the image */
        .summary-table tr:nth-child(1) td {
            background-color: #f0f2f5; /* Light grey background for Valor row */
            font-weight: bold;
            color: #333;
        }
        .summary-table tr:nth-child(1) td:last-child {
             color: #333;
        }

        /* Specific styling for the 'Ganancia' row to match the image's bolding */
        .summary-table tr:nth-child(3) td {
            background-color: #f0f2f5; /* Light grey background for Ganancia row */
            font-weight: bold;
            color: #333;
        }
        .summary-table tr:nth-child(3) td:last-child {
             color: #333;
        }


/*
  Estilos para la tabla de resumen de la colección.
  Versión final: sin título, sin margen y pegado a la cabecera.
*/

/* Oculta el título "Resumen de la colección" */
.lg\:w-96 .text-lg {
    display: none;
}

/* Contenedor principal del resumen en pantallas grandes (lg) */
@media (min-width: 1024px) {
    .lg\:w-96 {
        margin-top: 0 !important; /* Elimina el margen superior */
        top: 4rem !important;  /* NUEVO: Lo pega justo debajo de la cabecera (que mide 3.5rem) */
    }
}

/* Contenedor principal del resumen en pantallas pequeñas */
.lg\:w-96 {
    margin-top: 0.5rem; /* Mantiene un pequeño margen en móvil para que no se pegue arriba */
}

@media (max-width: 1024px) {
  .bg-white.mb-4 {
    margin-bottom: 0 !important;
  }
}

@media (max-width: 1024px) {
  .mt-6 {
    margin-top: 0.5rem !important; /* o 0 si quieres pegarlo */
  }
}


/* Contenedor de la tabla */
.lg\:w-96 > .bg-white {
    border: none !important;
    box-shadow: none !important;
}

/* Tabla de resumen */
.lg\:w-96 table {
    width: 100%;
    border-collapse: collapse;
    font-family: 'Inter', sans-serif;
    background-color: #ffffff;
    border-radius: 8px;
    overflow: hidden;
}

/* Celdas de la tabla (td) */
.lg\:w-96 table td {
    padding: 14px 15px;
    font-size: 16px;
    border-bottom: 1px solid #f8f8f8;
    vertical-align: middle;
}

/* Eliminar el borde de la última fila */
.lg\:w-96 table tr:last-of-type td {
    border-bottom: none;
}

/* Filas con fondo gris (la primera y la tercera) */
.lg\:w-96 table tr:nth-child(1) td,
.lg\:w-96 table tr:nth-child(3) td {
    background-color: #f1f8fe;
}

/* Celdas de la izquierda (Valor, Costo, etc.) */
.lg\:w-96 table td:first-child {
    font-weight: normal;
    color: #555;
}

/* Celdas de la derecha (los valores numéricos) */
.lg\:w-96 table td:last-child {
    font-weight: bold;
    color: #333;
    text-align: right;
}

/* Estilos para el menú de plataformas */
#platform-menu {
    position: absolute;
    /* Por defecto, lo anclamos a la izquierda del botón */
    left: 0;
    /* Ajustamos el ancho del menú para que no se desborde */
    width: max-content; /* O un ancho fijo, como 200px */
}

/* Media query para pantallas pequeñas */
@media (max-width: 1650px) {
    #platform-menu {
        /*
        1. Ancla el menú al borde derecho del contenedor (botón).
        2. `transform: translateX(100%)` mueve el menú 100% de su propio ancho a la derecha.
           Como `left: 100%` lo había movido 100% del ancho del botón a la derecha,
           esto lo ancla perfectamente al borde derecho.
        */
        right: 0;
        left: auto;
    }
}

</style>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=block" rel="stylesheet">
</head><body><div class="relative flex min-h-svh flex-col"><header class="border-border/40 bg-background/95 supports-[backdrop-filter]:bg-background/60 sticky top-0 z-50 h-14 w-full border-b backdrop-blur"><div class="container flex h-14 items-center justify-between"><div class="flex items-center"><a class="ml-2 mr-4 hidden font-bold sm:block orbitron-font __className_9fd9c5">Mi colección de videojuegos</a>
<a class="ml-2 mr-4 font-bold sm:hidden orbitron-font __className_9fd9c5">Mi colección</a>
</div><div class="flex items-center gap-3 relative ml-4">
  <button id="toggleForm"
  class="text-xl hover:bg-accent hover:text-accent-foreground rounded-md p-1"
  title="Añadir o editar" style="font-size: 1.25rem;">✏️</button>

  <button id="authStatus"
  class="mx-2 text-xl hover:bg-accent hover:text-accent-foreground rounded-md p-1"
  title="Estado autenticación" style="font-size: 1.25rem;">🔒</button>

  <button id="plus" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-70 hover:bg-accent hover:text-accent-foreground h-9 w-9" type="button" aria-haspopup="menu" aria-expanded="false" data-state="closed"style="color: #444444;">
  <svg xmlns="http://www.w3.org/2000/svg" version="1.0" width="28" height="28" viewBox="0 0 208 208" preserveAspectRatio="xMidYMid meet" fill="currentColor">
    <g transform="translate(0,208) scale(0.1,-0.1)" stroke="none">
      <path d="M1012 1580 c-12 -5 -27 -21 -32 -35 -6 -15 -10 -118 -10 -231 l0 -204 -209 0 c-115 0 -217 -3 -226 -6 -16 -6 -45 -54 -45 -74 0 -6 11 -22 25 -35 24 -25 24 -25 239 -25 l215 0 3 -221 c3 -218 3 -221 27 -240 30 -24 52 -24 85 2 l26 20 0 220 0 219 218 0 c215 0 219 0 240 23 29 30 28 62 -3 92 -24 25 -24 25 -240 25 l-215 0 0 219 0 220 -26 20 c-29 23 -38 24 -72 11z"/>
    </g>
  </svg><span class="sr-only">Añadir</span></button></div>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCb5vmEqe_IIasGYvH7e1g1ja56RwSoTSI",
    authDomain: "videojuegos-cfdee.firebaseapp.com",
    projectId: "videojuegos-cfdee",
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const gameForm = document.getElementById("gameForm");
  const toggleForm = document.getElementById("toggleForm");
  const loginTooltip = document.getElementById("loginTooltip");

  let user = null;

  auth.onAuthStateChanged((u) => {
    user = u;
    document.getElementById("authStatus").textContent = user ? "🔓" : "🔒";
  });

  // --- AÑADE ESTE CÓDIGO AQUÍ ---
  // Lógica para guardar y cargar la página actual en localStorage
  let currentPage = 1;

  // Cargar la página desde localStorage al iniciar
  const savedPage = localStorage.getItem('currentPage');
  if (savedPage) {
    currentPage = parseInt(savedPage, 10);
  }

  // Cargar los juegos de la página actual, ya sea la guardada o la 1
  renderGamesPage(currentPage);

  // Función para guardar la página en localStorage al cambiar
  function setCurrentPage(pageNumber) {
    currentPage = pageNumber;
    localStorage.setItem('currentPage', pageNumber);
  }
  // --- FIN DEL CÓDIGO A AÑADIR ---

    tailwind.config = {
    safelist: [
      'bg-gray-50',
      'bg-blue-50',
      'text-blue-800',
      'text-green-600',
      'text-gray-500'
    ]
  }
</script></header><main class="flex grow flex-col items-stretch"><div class="lg:container lg:flex lg:flex-1 lg:flex-row"><div class="mt-6 block lg:sticky lg:top-20 lg:mr-2 lg:h-[calc(100vh-5rem)] lg:w-96 lg:min-w-96">
  
  <!-- NUEVA TABLA: Resumen de la colección -->
  <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-4 mb-4">
    <h2 class="text-lg font-bold text-gray-800 mb-4">Resumen de la colección</h2>
    <table class="w-full border-collapse">
      <tr class="bg-gray-200">
        <td class="py-2 px-3 text-gray-800">Valor</td>
        <td id="summary-value" class="py-2 px-3 text-right font-bold text-gray-800">0 €</td>
      </tr>
      <tr class="bg-gray-50">
        <td class="py-2 px-3 text-gray-600">Costo</td>
        <td id="summary-cost" class="py-2 px-3 text-right font-bold text-gray-800">0 €</td>
      </tr>
      <tr class="bg-gray-200">
        <td class="py-2 px-3 text-gray-800">Diferencia</td>
        <td id="summary-diff" class="py-2 px-3 text-right font-bold text-gray-800">0 €</td>
      </tr>
      <tr class="bg-gray-50">
        <td class="py-2 px-3 text-gray-600">Cantidad</td>
        <td id="summary-count" class="py-2 px-3 text-right font-bold text-gray-800">0</td>
      </tr>
    </table>
  </div>

</div>


<div class="mt-6 grow lg:mt-4"><div dir="ltr" data-orientation="horizontal" class="w-full px-2 lg:px-0"></div><div class="mx-2 lg:mx-0"><div class="mb-2">
    
<!-- Modal login -->
<div id="loginModal" class="fixed inset-0 hidden flex justify-center items-center z-50 bg-black bg-opacity-70 backdrop-blur-sm">
  <div id="loginBox" class="bg-white p-6 rounded-xl max-w-sm w-full relative shadow">
    <h2 class="text-xl font-bold mb-4 text-gray-800">Iniciar sesión</h2>

    <input id="loginEmail" type="email" placeholder="Correo"
      class="w-full mb-2 border border-gray-300 p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-300" />

    <input id="loginPassword" type="password" placeholder="Contraseña"
      class="w-full mb-4 border border-gray-300 p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-300" />

    <button id="loginSubmit">
      Acceder
    </button>

    <button id="logoutButton"
      class="text-gray-500 hover:text-gray-700 text-sm px-2 py-1 mt-2 mx-auto block">
      Salir
    </button>
  </div>
</div>


  <!-- Tooltip de Iniciar sesión -->
<div id="loginTooltip">
  <div class="relative bg-red-100 border border-red-300 text-red-900 rounded-xl shadow px-4 py-3 text-sm">
    <div class="arrow"></div>
    <p class="mb-2">Inicia sesión para poder añadir o editar juegos.</p>
  </div>
</div>


  <!-- Modal Overlay -->
  <div id="modalOverlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 hidden items-center justify-center px-4 py-8"> 
    <!-- Formulario en modal -->
    <form id="gameForm" class="form-grid bg-white p-4 rounded-xl shadow-xl mb-8 w-full max-w-4xl opacity-0 scale-95 transition-all duration-300">

  <div class="form-row-2">
    <div class="form-item">
      <div class="form-emoji">🖼️</div>
      <input type="url" id="imageUrl" placeholder="URL de imagen*" class="form-input" required />
    </div>
    <div class="form-item">
      <div class="form-emoji">🔠</div>
      <input type="text" id="title" placeholder="Título*" class="form-input" required />
    </div>
  </div>

  <div class="form-row-2">
    <div class="form-item">
      <div class="form-emoji">🎮</div>
      <select id="platform" class="form-input" required>
        <option value="" disabled selected>Plataforma*</option>
        <option value="Game Boy Advance">Game Boy Advance</option>
        <option value="Nintendo 3DS">Nintendo 3DS</option>
        <option value="Nintendo 64">Nintendo 64</option>
        <option value="Nintendo DS">Nintendo DS</option>
        <option value="Nintendo Switch">Nintendo Switch</option>
        <option value="Nintendo Wii">Nintendo Wii</option>
        <option value="Nintendo Wii U">Nintendo Wii U</option>
        <option value="PlayStation">PlayStation</option>
        <option value="PlayStation 2">PlayStation 2</option>
        <option value="PlayStation 3">PlayStation 3</option>
        <option value="PlayStation 4">PlayStation 4</option>
        <option value="PlayStation 5">PlayStation 5</option>
        <option value="Xbox 360">Xbox 360</option>
      </select>
    </div>
    <div class="form-item">
      <div class="form-emoji">📂</div>
      <select id="folder" class="form-input" required>
        <option value="" disabled selected>Carpeta*</option>
        <option value="Colección">Colección</option>
        <option value="Extras">Extras</option>
      </select>
    </div>
  </div>

  <div class="form-row-2">
    <div class="form-item">
      <div class="form-emoji">📦</div>
      <select id="condition" class="form-input" required>
        <option value="" disabled selected>Condición*</option>
        <option value="Nuevo">Nuevo</option>
        <option value="CIB">CIB</option>
        <option value="Item y Caja">Item y Caja</option>
        <option value="Item y Manual">Item y Manual</option>
        <option value="Caja y Manual">Caja y Manual</option>
        <option value="Solo Item">Solo Item</option>
        <option value="Solo Caja">Solo Caja</option>
        <option value="Solo Manual">Solo Manual</option>
      </select>
    </div>
    <div class="form-item" id="estadoStarsContainer" title="Estado">
      <div class="form-emoji">⭐</div>
      <div id="estadoStars" class="flex gap-1 text-yellow-400 text-3xl">
        <span data-star="1">☆</span>
        <span data-star="2">☆</span>
        <span data-star="3">☆</span>
        <span data-star="4">☆</span>
        <span data-star="5">☆</span>
      </div>
    </div>
  </div>

  <div class="form-row-2">
    <div class="form-item">
      <div class="form-emoji">🛒</div>
      <input type="text" id="purchaseDate" onfocus="this.type='date'" onblur="if(this.value===''){this.type='text'}" placeholder="Fecha de compra*" class="form-input" required />
    </div>
    <div class="form-item">
      <div class="form-emoji">🆕</div>
      <input type="text" id="releaseDate" onfocus="this.type='date'" onblur="if(this.value===''){this.type='text'}" placeholder="Fecha de lanzamiento" class="form-input" />
    </div>
  </div>

  <div class="form-row-3">
    <div class="form-item">
      <div class="form-emoji">📍</div>
      <input type="text" id="purchaseLocation" placeholder="Lugar de compra" class="form-input" />
    </div>
    <div class="form-item">
      <div class="form-emoji">🌍</div>
      <input type="text" id="region" placeholder="Región" class="form-input" />
    </div>
    <div class="form-item">
      <div class="form-emoji">🎁</div>
      <input type="text" id="gift" placeholder="Regalo" class="form-input" />
    </div>
  </div>

  <div class="form-row-3 md:col-span-2">
    <div class="form-item">
  <div class="form-emoji">🗃️</div>
  <select id="edition" class="form-input" required>
    <option value="" disabled selected>Edición*</option>
    <option value="Básica">Básica</option>
    <option value="Reedición (Platinum, etc)">Reedición (Platinum, etc)</option>
    <option value="Especial">Especial</option>
  </select>
</div>
  <div class="form-item">
    <div class="form-emoji">💸</div>
    <input type="number" id="cost" placeholder="Coste (€)" step="0.01" class="form-input"/>
  </div>
  <div class="form-item">
    <div class="form-emoji">💰</div>
    <input type="number" id="value" placeholder="Valor (€)" step="0.01" class="form-input" />
  </div>
</div>

  <div class="form-row-3">
    <div class="form-item">
      <div class="form-emoji">
        <img src="https://i.ibb.co/RpbCN10H/217439.png" alt="Wallapop" class="w-6 h-6" style="width: 1em; height: 1em;"/>
      </div>
      <input type="url" id="wallapopLink" placeholder="Enlace Wallapop" class="form-input" />
    </div>
    <div class="form-item">
      <div class="form-emoji">
        <img src="https://i.ibb.co/gY2Tqd5/217438.png" alt="Vinted" class="w-6 h-6" style="width: 1em; height: 1em;"/>
      </div>
      <input type="url" id="vintedLink" placeholder="Enlace Vinted" class="form-input" />
    </div>
    <div class="form-item">
      <div class="form-emoji">
        <img src="https://i.ibb.co/67Mcg0Qd/217436.png" alt="Ebay" class="w-6 h-6" style="width: 1em; height: 1em;"/>
      </div>
      <input type="url" id="ebayLink" placeholder="Enlace eBay" class="form-input" />
    </div>
  </div>

  <div class="form-row-2">
    <div class="form-item">
      <div class="form-emoji">🤑</div>
      <input type="number" id="cex" placeholder="Cex (€)" step="0.01" class="form-input" />
    </div>
    <div class="form-item">
      <div class="form-emoji">
        <img src="https://i.ibb.co/kg4KSbJX/217437.png" alt="Cex" class="w-6 h-6" style="width: 1em; height: 1em;"/>
      </div>
      <input type="url" id="cexLink" placeholder="Enlace Cex" class="form-input" />
    </div>
  </div>

  <div class="form-row">
    <div class="form-item w-full">
      <div class="form-emoji">📄</div>
      <textarea id="details" placeholder="Detalles" class="form-input w-full" style="min-height: 100px; resize: vertical;"></textarea>
    </div>
  </div>

  <button type="submit" id="guardarSubmit">Guardar</button>

</form>
  </div>

<!-- Modal de detalles -->
<div id="modal" class="fixed inset-0 bg-black bg-opacity-60 hidden justify-center items-center z-50">
  <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-3xl overflow-hidden relative custom-scroll">
    <button id="closeModalBtn" class="absolute top-2 right-3 text-sm font-semibold text-gray-500 hover:text-gray-800 transition-colors duration-200">✕</button>

    <div id="modalHeader" class="flex flex-col items-center mb-4">
      </div>

    <img id="modalImage" src="" class="w-full max-h-[400px] object-contain rounded mb-4" />

    <div id="modalDetails" class="text-gray-700">
      </div>

    <div id="modalButtons" class="flex justify-center gap-4 mt-6 hidden">
      <button id="editBtn" title="Editar juego" class="text-blue-600 text-xl">✏️</button>
      <button id="deleteBtn" title="Borrar juego" class="text-red-600 text-xl">🗑️</button>
    </div>
  </div>
</div>

<div id="fullscreenImageModal" class="fullscreen-image-modal">
  <img id="fullscreenImageView" src="" alt="Carátula en pantalla completa" class="fullscreen-image">
</div>

    <div class="mt-2 flex flex-col items-center space-y-2 lg:flex-row lg:space-x-2 lg:space-y-0"><input id="searchInput" class="border-input placeholder:text-muted-foreground focus-visible:ring-ring flex h-9 w-full rounded-md border bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium focus-visible:outline-none focus-visible:ring-1 disabled:cursor-not-allowed disabled:opacity-50" placeholder="Buscar videojuegos..." autocomplete="off" autocorrect="off" spellcheck="false"><div class="flex w-full flex-row space-x-2 lg:w-auto">



        <!-- Contenedor de los botones -->
        <div class="flex w-full flex-row space-x-2 lg:w-auto justify-between">
          
    <!-- Botón principal de orden (ORDENACIÓN) -->
    <div class="relative inline-block text-left w-full lg:w-auto">
      <button 
        class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-70 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2 w-full lg:w-auto"
        type="button" 
        id="sort-button" 
        aria-haspopup="menu" 
        aria-expanded="false" 
        data-state="closed"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up-down mr-1 h-4">
          <path d="m21 16-4 4-4-4"></path>
          <path d="M17 20V4"></path>
          <path d="m3 8 4-4 4 4"></path>
          <path d="M7 4v16"></path>
        </svg>
        <div class="hidden lg:block" id="sort-button-label">Últimas compras</div>
      </button>

      <!-- Menú desplegable que sale debajo -->
        <div id="sort-menu" class="hidden absolute right-0 mt-2 w-[11rem] origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none z-50 border border-gray-200" style="background-color: white !important;">
        <div class="py-1">
          <div id="option-lastpurchase" class="block px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-100">Últimas compras</div>
          <div id="option-firstpurchase" class="block px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-100">Primeras compras</div>
          <div id="option-alphabetical" class="block px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-100">Alfabético (A-Z)</div>
          <div id="option-alphabetical-reverse" class="block px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-100">Alfabético (Z-A)</div>
          <div id="option-newest" class="block px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-100">Más nuevos</div>
          <div id="option-oldest" class="block px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-100">Más antiguos</div>
          <div id="option-value-high" class="block px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-100">Mayor valor</div>
          <div id="option-value-low" class="block px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-100">Menor valor</div>
          <div id="option-cost-high" class="block px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-100">Mayor coste</div>
          <div id="option-cost-low" class="block px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-100">Menor coste</div>
        </div>
    </div>
    </div>

  <!-- Botón 2: All -->
  <div class="relative inline-block text-left w-full lg:w-auto">
  <button 
    class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-70 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2 w-full lg:w-auto"
    type="button"
    id="all-button"
    aria-haspopup="menu"
    aria-expanded="false"
    data-state="closed"
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list-filter mr-1 h-4">
      <path d="M3 6h18"></path>
      <path d="M7 12h10"></path>
      <path d="M10 18h4"></path>
    </svg>
    <div class="hidden lg:block" id="all-button-label">Todo</div>
  </button>

  <!-- Menú desplegable que sale debajo para All -->
  <div id="all-menu" class="hidden absolute right-0 mt-2 w-36 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none z-50 border border-gray-200" style="background-color: white !important;">
 <div class="py-1">
      <div id="option-all" class="block px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-100">Todo</div>
      <div id="option-basic" class="block px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-100">Básica</div>
      <div id="option-reissue" class="block px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-100">Reedición</div>
      <div id="option-special" class="block px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-100">Especial</div>
    </div>
  </div>
  </div>


<!-- Botón de plataforma actualizado -->
<div class="relative inline-block text-left w-full lg:w-auto">
  <button id="platform-button"
    class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-70 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2 w-full lg:w-auto"
    type="button"
    aria-haspopup="menu"
    aria-expanded="false"
    data-state="closed"
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-gamepad2 mr-1 h-4">
        <line x1="6" x2="10" y1="11" y2="11"></line>
        <line x1="8" x2="8" y1="9" y2="13"></line>
        <line x1="15" x2="15.01" y1="12" y2="12"></line>
        <line x1="18" x2="18.01" y1="10" y2="10"></line>
        <path d="M17.32 5H6.68a4 4 0 0 0-3.978 3.59c-.006.052-.01.101-.017.152C2.604 9.416 2 14.456 2 16a3 3 0 0 0 3 3c1 0 1.5-.5 2-1l1.414-1.414A2 2 0 0 1 9.828 16h4.344a2 2 0 0 1 1.414.586L17 18c.5.5 1 1 2 1a3 3 0 0 0 3-3c0-1.545-.604-6.584-.685-7.258-.007-.05-.011-.1-.017-.151A4 4 0 0 0 17.32 5z"></path>
      </svg>
    <div class="hidden lg:block" id="platform-button-label">Todo</div>
  </button>

  <div id="platform-menu" class="hidden absolute right-0 mt-2 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none z-50 border border-gray-200" style="background-color: white !important; width: 11rem !important;">
    <div class="py-1">
      <div id="platform-option-all" class="block px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-100">Todo</div>
      <div id="platform-option-gba" class="block px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-100">Game Boy Advance</div>
      <div id="platform-option-3ds" class="block px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-100">Nintendo 3DS</div>
      <div id="platform-option-ds" class="block px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-100">Nintendo DS</div>
      <div id="platform-option-n64" class="block px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-100">Nintendo 64</div>
      <div id="platform-option-switch" class="block px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-100">Nintendo Switch</div>
      <div id="platform-option-wii" class="block px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-100">Nintendo Wii</div>
      <div id="platform-option-wiiu" class="block px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-100">Nintendo Wii U</div>
      <div id="platform-option-ps" class="block px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-100">PlayStation</div>
      <div id="platform-option-ps2" class="block px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-100">PlayStation 2</div>
      <div id="platform-option-ps3" class="block px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-100">PlayStation 3</div>
      <div id="platform-option-ps4" class="block px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-100">PlayStation 4</div>
      <div id="platform-option-ps5" class="block px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-100">PlayStation 5</div>
      <div id="platform-option-x360" class="block px-4 py-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-100">Xbox 360</div>
    </div>
  </div>
</div>

</div>
          
          
        
        </div></div><div id="games-container" class="grid-cols-previews mb-2 mt-1 grid"></div><div id="pagination" class="mt-4"></div>
      </main></div><link rel="preload" as="image" href="https://static-resource.np.community.playstation.net/avatar_xl/WWS_A/A2103_xl.png" fetchpriority="high"><next-route-announcer style="position: absolute;"><template shadowrootmode="open"><div aria-live="assertive" id="__next-route-announcer__" role="alert" style="position: absolute; border: 0px; height: 1px; margin: -1px; padding: 0px; width: 1px; clip: rect(0px, 0px, 0px, 0px); overflow: hidden; white-space: nowrap; overflow-wrap: normal;">adricollantex • Platinum Hunt</div></template></next-route-announcer>
<script>

document.addEventListener('DOMContentLoaded', () => {
  const authStatusBtn = document.getElementById('authStatus');
  const loginModal = document.getElementById('loginModal');
  const loginBox = document.getElementById('loginBox');
  const loginEmail = document.getElementById('loginEmail');
  const loginPassword = document.getElementById('loginPassword');
  const loginSubmit = document.getElementById('loginSubmit');
  const logoutButton = document.getElementById('logoutButton');
  const gamesContainer = document.getElementById('games-container'); // ✅ asegúrate que esto exista
  const purchaseDateInput = document.getElementById('purchaseDate');
  const releaseDateInput = document.getElementById('releaseDate');
  const modal = document.getElementById('modal');
  const fullscreenImageModal = document.getElementById('fullscreenImageModal');
  const fullscreenImageView = document.getElementById('fullscreenImageView');
  
  const modalContent = document.querySelector('#modal > div');

  const editBtn = document.getElementById("editBtn");
  const allButton = document.getElementById('all-button');
  const allMenu = document.getElementById('all-menu');
  const allButtonLabel = document.getElementById('all-button-label');

  // Referencias a todas las opciones del menú de edición
  const optionAll = document.getElementById('option-all');
  const optionBasic = document.getElementById('option-basic');
  const optionReissue = document.getElementById('option-reissue');
  const optionSpecial = document.getElementById('option-special');

const platformButton = document.getElementById('platform-button');
  const platformMenu = document.getElementById('platform-menu');
  const platformButtonLabel = document.getElementById('platform-button-label');

  // Array para guardar las plataformas seleccionadas
  let selectedPlatforms = [];
let selectedEditionType = 'all'; // Inicialmente, "Todo" está seleccionado

  // Referencias a todas las opciones del menú de plataforma
  const platformOptionAll = document.getElementById('platform-option-all');
  const platformOptionGBA = document.getElementById('platform-option-gba');
  const platformOption3DS = document.getElementById('platform-option-3ds');
  const platformOptionDS = document.getElementById('platform-option-ds');
  const platformOptionN64 = document.getElementById('platform-option-n64');
  const platformOptionSwitch = document.getElementById('platform-option-switch');
  const platformOptionWii = document.getElementById('platform-option-wii');
  const platformOptionWiiU = document.getElementById('platform-option-wiiu');
  const platformOptionPS = document.getElementById('platform-option-ps');
  const platformOptionPS2 = document.getElementById('platform-option-ps2');
  const platformOptionPS3 = document.getElementById('platform-option-ps3');
  const platformOptionPS4 = document.getElementById('platform-option-ps4');
  const platformOptionPS5 = document.getElementById('platform-option-ps5');
  const platformOptionX360 = document.getElementById('platform-option-x360');

editBtn.addEventListener("click", () => {
  const modal = document.getElementById("modal");
  const index = parseInt(modal.dataset.currentIndex);

  if (!isNaN(index) && games[index]) {
    modal.classList.add("hidden"); // Oculta el modal principal
    openEditModal(games[index]);   // Abre el modalOverlay con formulario relleno
  }
});



  modalContent.addEventListener('wheel', (e) => {
    const delta = e.deltaY;
    const scrollTop = modalContent.scrollTop;
    const scrollHeight = modalContent.scrollHeight;
    const clientHeight = modalContent.clientHeight;

    if (
      (delta < 0 && scrollTop === 0) || // scroll up cuando ya estás arriba
      (delta > 0 && scrollTop + clientHeight >= scrollHeight) // scroll down cuando ya estás abajo
    ) {
      e.preventDefault(); // evita que se propague el scroll
    }
  }, { passive: false });

const scrollable = document.querySelector('.custom-scroll');

  scrollable.addEventListener('touchstart', function (e) {
    this.startY = e.touches[0].clientY;
  }, { passive: false });

  scrollable.addEventListener('touchmove', function (e) {
    const currentY = e.touches[0].clientY;
    const scrollTop = this.scrollTop;
    const scrollHeight = this.scrollHeight;
    const clientHeight = this.clientHeight;
    const isScrollingUp = currentY > this.startY;
    const isScrollingDown = currentY < this.startY;

    const atTop = scrollTop === 0;
    const atBottom = scrollTop + clientHeight >= scrollHeight;

    if ((atTop && isScrollingUp) || (atBottom && isScrollingDown)) {
      e.preventDefault(); // bloquea el scroll del fondo
    }
  }, { passive: false });

  let isAuthenticated = false;

  function updateAuthStatusIcon(user) {
    if (user) {
      isAuthenticated = true;
      authStatusBtn.textContent = '🔓';
      authStatusBtn.title = `Autenticado como: ${user.email}`;
    } else {
      isAuthenticated = false;
      authStatusBtn.textContent = '🔒';
      authStatusBtn.title = 'No autenticado';
    }
  }

const sortButton = document.getElementById('sort-button');
    const sortMenu = document.getElementById('sort-menu');
    const sortButtonLabel = document.getElementById('sort-button-label');

    // Referencias a todas las opciones del menú de ordenación
    const optionLastPurchase = document.getElementById('option-lastpurchase');
    const optionFirstPurchase = document.getElementById('option-firstpurchase');
    const optionAlphabetical = document.getElementById('option-alphabetical');
    const optionAlphabeticalReverse = document.getElementById('option-alphabetical-reverse');
    const optionNewest = document.getElementById('option-newest');
    const optionOldest = document.getElementById('option-oldest');
    const optionValueHigh = document.getElementById('option-value-high');
    const optionValueLow = document.getElementById('option-value-low');
    const optionCostHigh = document.getElementById('option-cost-high');
    const optionCostLow = document.getElementById('option-cost-low');

    // Variable para almacenar el orden original de los juegos, tal como vienen de Firebase
    let originalGamesOrder = [];

    // --- Funciones de Ordenación ---

    // Función para marcar la opción seleccionada en el menú
    // `menuId` es el ID del contenedor del menú (e.g., 'sort-menu')
    // `selectedOptionId` es el ID de la opción que queremos marcar
    // Función para marcar la opción seleccionada en el menú
    // `menuId` es el ID del contenedor del menú (e.g., 'sort-menu', 'all-menu', 'platform-menu')
    // `selectedOptionId` es el ID de la opción que queremos marcar
    // `marker` es el carácter a usar para marcar (e.g., '· ', '✓ ')
    function selectOption(menuId, selectedOptionId, marker = '· ') {
        const menuOptions = document.querySelectorAll(`#${menuId} > div > div`); // Selecciona todos los divs de opción
        menuOptions.forEach(option => {
            // Quita cualquier marcador existente (ya sea '· ' o '✓ ')
            let optionText = option.textContent;
            if (optionText.startsWith('· ')) {
                optionText = optionText.substring(2);
            } else if (optionText.startsWith('✓ ')) {
                optionText = optionText.substring(2);
            }
            option.textContent = optionText; // Restablece el texto sin el marcador
        });

        const selectedOption = document.getElementById(selectedOptionId);
        if (selectedOption) {
            selectedOption.textContent = marker + selectedOption.textContent; // Añade el marcador
        }
    }

    // Nueva función para manejar el marcado de múltiples opciones de plataforma
    function togglePlatformOption(optionId, platformName) {
  const optionElement = document.getElementById(optionId);
  const isSelected = optionElement.textContent.startsWith('✓ ');

  if (platformName === 'all') {
    selectedPlatforms = ['all'];
    document.querySelectorAll('#platform-menu > div > div').forEach(option => {
      if (option.id === optionId) {
        if (!option.textContent.startsWith('✓ ')) option.textContent = '✓ ' + option.textContent;
      } else {
        option.textContent = option.textContent.replace('✓ ', '');
      }
    });
  } else {
    selectedPlatforms = selectedPlatforms.filter(p => p !== 'all');
    if (isSelected) {
      optionElement.textContent = optionElement.textContent.replace('✓ ', '');
      selectedPlatforms = selectedPlatforms.filter(p => p !== platformName);
    } else {
      optionElement.textContent = '✓ ' + optionElement.textContent;
      selectedPlatforms.push(platformName);
    }
    if (selectedPlatforms.length === 0) {
      selectedPlatforms = ['all'];
      const allOption = document.getElementById('platform-option-all');
      if (allOption && !allOption.textContent.startsWith('✓ ')) {
        allOption.textContent = '✓ ' + allOption.textContent;
      }
    } else {
      const allOption = document.getElementById('platform-option-all');
      if (allOption) {
        allOption.textContent = allOption.textContent.replace('✓ ', '');
      }
    }
  }

  updatePlatformButtonLabel();

  // 🔹 Reset URL y página
  window.location.hash = '#page=1';
  setCurrentPage(1);
  renderGamesPage(currentPage);

}


    // Nueva función para actualizar el texto del botón de plataforma
function updatePlatformButtonLabel() {
    if (selectedPlatforms.length === 0 || (selectedPlatforms.length === 1 && selectedPlatforms[0] === 'all')) {
        platformButtonLabel.textContent = 'Todo';
        return;
    }

    // Define las abreviaturas o nombres personalizados para cada plataforma
    const platformLabels = {
        'Game Boy Advance': 'GBA',
        'Nintendo 3DS': '3DS',
        'Nintendo DS': 'DS',
        'Nintendo 64': 'N64',
        'Nintendo Switch': 'Switch',
        'Nintendo Wii': 'Wii',
        'Nintendo Wii U': 'Wii U',
        'PlayStation': 'PS1',
        'PlayStation 2': 'PS2',
        'PlayStation 3': 'PS3',
        'PlayStation 4': 'PS4',
        'PlayStation 5': 'PS5',
        'Xbox 360': 'X360'
    };

// Define el orden fijo en que quieres mostrar las plataformas
    const platformOrder = [
        'Game Boy Advance',
        'Nintendo 3DS',
        'Nintendo DS',
        'Nintendo 64',
        'Nintendo Switch',
        'Nintendo Wii',
        'Nintendo Wii U',
        'PlayStation',
        'PlayStation 2',
        'PlayStation 3',
        'PlayStation 4',
        'PlayStation 5',
        'Xbox 360'
    ];

    // Número máximo de plataformas a mostrar antes de poner "..."
    const maxOptionsToShow = 5;

    // Filtrar platformOrder para solo dejar las seleccionadas
    const orderedSelected = platformOrder.filter(p => selectedPlatforms.includes(p));

    // Mapear a etiquetas personalizadas
    const mappedLabels = orderedSelected.map(p => platformLabels[p] || p);

    // Tomar solo las primeras maxOptionsToShow opciones
    let displayedLabels = mappedLabels.slice(0, maxOptionsToShow);

    // Construir texto y añadir "..." si hace falta
    let labelText = displayedLabels.join(', ');
    if (orderedSelected.length > maxOptionsToShow) {
        labelText += '...';
    }

    platformButtonLabel.textContent = labelText;
}

        // Variable para almacenar los juegos filtrados actualmente
    let filteredGames = [];

function updateCollectionSummary(gamesToSum) {
  const list = Array.isArray(gamesToSum) ? gamesToSum : games;

  let totalValue = 0;
  let totalCost = 0;
  let count = 0;

  list.forEach(game => {
    const value = parseFloat(game.value) || 0;
    const cost = parseFloat(game.cost) || 0;
    totalValue += value;
    totalCost += cost;
    count++;
  });

    const diff = totalValue - totalCost;

  // Función para formatear moneda sin espacio y sin decimales si es entero
  const formatMoney = (num) => {
    const options = {
      minimumFractionDigits: num % 1 === 0 ? 0 : 2,
      maximumFractionDigits: num % 1 === 0 ? 0 : 2,
      useGrouping: true
    };
    // Formateamos solo el número
    const formattedNumber = num.toLocaleString('es-ES', options);
    // Añadimos el símbolo € sin espacio
    return `${formattedNumber} €`;
  };

  const isEmpty = list.length === 0;

document.getElementById('summary-value').textContent = isEmpty ? formatMoney(0) : formatMoney(totalValue);
document.getElementById('summary-cost').textContent = isEmpty ? formatMoney(0) : formatMoney(totalCost);
document.getElementById('summary-diff').textContent = isEmpty ? formatMoney(0) : formatMoney(diff);
document.getElementById('summary-count').textContent = count;

}



// Función central para aplicar todos los filtros activos (ordenación, edición, plataforma)
function applyAllFilters() {
  // AÑADE ESTAS DOS LÍNEAS AQUÍ, AL PRINCIPIO DE LA FUNCIÓN
    currentSearchTerm = "";
    searchInput.value = "";
    // 1. Empezar con el orden original
    games = [...originalGamesOrder];

    // 2. Aplicar filtro de edición si hay uno seleccionado
    // Usamos selectedEditionType en lugar de allButtonLabel.textContent
    if (selectedEditionType !== 'all') {
        const editionMap = {
            'Básica': 'Básica',
            'Reedición': 'Reedición',
            'Especial': 'Especial'
        };
        const editionFilterValue = editionMap[selectedEditionType]; // Usar selectedEditionType
        if (editionFilterValue) {
            games = games.filter(game => {
                const edition = game.edition ? game.edition.toLowerCase() : '';
                return edition.includes(editionFilterValue.toLowerCase());
            });
        }
    }

    // 3. Aplicar filtro de plataforma si hay alguna seleccionada (excluyendo "Todo" si es la única seleccionada)
    const activePlatforms = selectedPlatforms.filter(p => p !== 'all');
    if (activePlatforms.length > 0) {
        games = games.filter(game => {
  const platform = (game.platform || '').toLowerCase().trim();
  return activePlatforms.some(selected => selected.toLowerCase().trim() === platform);
});
    }
    
    // 4. Aplicar ordenación (usa el label actual del sort-button para saber qué ordenación aplicar)
    const currentSortLabel = sortButtonLabel.textContent;
    switch (currentSortLabel) {
        case 'Últimas compras':
            // Las funciones de ordenación no necesitan redibujar la página, solo ordenar el array 'games'
            games.sort((a, b) => new Date(b.purchaseDate).getTime() - new Date(a.purchaseDate).getTime());
            break;
        case 'Primeras compras':
            games.sort((a, b) => new Date(a.purchaseDate).getTime() - new Date(b.purchaseDate).getTime());
            break;
        case 'Alfabético (A-Z)':
            games.sort((a, b) => a.title.toLowerCase().localeCompare(b.title.toLowerCase()));
            break;
        case 'Alfabético (Z-A)':
            games.sort((a, b) => b.title.toLowerCase().localeCompare(a.title.toLowerCase()));
            break;
        case 'Más nuevos':
            games.sort((a, b) => {
                const dateA = new Date(a.releaseDate);
                const dateB = new Date(b.releaseDate);
                if (!a.releaseDate) return 1;
                if (!b.releaseDate) return -1;
                return dateB.getTime() - dateA.getTime();
            });
            break;
        case 'Más antiguos':
            games.sort((a, b) => {
                const dateA = new Date(a.releaseDate);
                const dateB = new Date(b.releaseDate);
                if (!a.releaseDate) return -1;
                if (!b.releaseDate) return 1;
                return dateA.getTime() - dateB.getTime();
            });
            break;
        case 'Mayor valor':
            games.sort((a, b) => (parseFloat(b.value) || 0) - (parseFloat(a.value) || 0));
            break;
        case 'Menor valor':
            games.sort((a, b) => (parseFloat(a.value) || 0) - (parseFloat(b.value) || 0));
            break;
        case 'Mayor coste':
            games.sort((a, b) => (parseFloat(b.cost) || 0) - (parseFloat(a.cost) || 0));
            break;
        case 'Menor coste':
            games.sort((a, b) => (parseFloat(a.cost) || 0) - (parseFloat(b.cost) || 0));
            break;
        default:
            // Si no hay un orden específico, mantiene el orden actual después de filtros
            break;
    }

    currentPage = 1;
    renderGamesPage(currentPage);
    renderPagination();
    updateCollectionSummary();
}

    function sortGamesByPurchaseDate(order = 'desc') { // 'desc' para últimas compras, 'asc' para primeras
        games.sort((a, b) => {
            const dateA = new Date(a.purchaseDate);
            const dateB = new Date(b.purchaseDate);
            if (order === 'desc') {
                return dateB.getTime() - dateA.getTime();
            } else {
                return dateA.getTime() - dateB.getTime();
            }
        });
        currentPage = 1; // Volver a la primera página después de ordenar
        renderGamesPage(currentPage);
        renderPagination();
        updateCollectionSummary();
        applyFiltersAndReset();

    }

    function sortGamesAlphabetically(order = 'asc') { // 'asc' para A-Z, 'desc' para Z-A
        games.sort((a, b) => {
            const titleA = a.title.toLowerCase();
            const titleB = b.title.toLowerCase();
            if (order === 'asc') {
                return titleA.localeCompare(titleB);
            } else {
                return titleB.localeCompare(titleA);
            }
        });
        currentPage = 1;
        renderGamesPage(currentPage);
        renderPagination();
        updateCollectionSummary();
        applyFiltersAndReset();
    }

    function sortGamesByReleaseDate(order = 'desc') { // 'desc' para más nuevos, 'asc' para más antiguos
        games.sort((a, b) => {
            const dateA = new Date(a.releaseDate);
            const dateB = new Date(b.releaseDate);
            // Manejar fechas vacías o inválidas: se consideran más "antiguas"
            if (!a.releaseDate) return order === 'desc' ? 1 : -1;
            if (!b.releaseDate) return order === 'desc' ? -1 : 1;

            if (order === 'desc') {
                return dateB.getTime() - dateA.getTime();
            } else {
                return dateA.getTime() - dateB.getTime();
            }
        });
        currentPage = 1;
        renderGamesPage(currentPage);
        renderPagination();
        updateCollectionSummary();
        applyFiltersAndReset();

    }

    function sortGamesByValue(order = 'desc') { // 'desc' para mayor valor, 'asc' para menor valor
        games.sort((a, b) => {
            const valueA = parseFloat(a.value) || 0;
            const valueB = parseFloat(b.value) || 0;
            if (order === 'desc') {
                return valueB - valueA;
            } else {
                return valueA - valueB;
            }
        });
        currentPage = 1;
        renderGamesPage(currentPage);
        renderPagination();
        updateCollectionSummary();
        applyFiltersAndReset();

    }

    function sortGamesByCost(order = 'desc') { // 'desc' para mayor coste, 'asc' para menor coste
        games.sort((a, b) => {
            const costA = parseFloat(a.cost) || 0;
            const costB = parseFloat(b.cost) || 0;
            if (order === 'desc') {
                return costB - costA;
            } else {
                return costA - costB;
            }
        });
        currentPage = 1;
        renderGamesPage(currentPage);
        renderPagination();
        updateCollectionSummary();
        applyFiltersAndReset();

    }

    // --- Event Listeners para el botón y las opciones de ordenación ---

    // Función para alternar el menú de ordenación
    function toggleSortMenu() {
        sortMenu.classList.toggle('hidden');
        // Asegúrate de cerrar otros menús si los tienes (como allMenu, platformMenu)
        if (typeof allMenu !== 'undefined') allMenu.classList.add('hidden');
        if (typeof platformMenu !== 'undefined') platformMenu.classList.add('hidden');
        // Actualiza el aria-expanded del botón
        sortButton.setAttribute('aria-expanded', sortMenu.classList.contains('hidden') ? 'false' : 'true');
    }
    // Asigna la función toggleSortMenu al botón
    sortButton.addEventListener('click', (e) => {
        e.stopPropagation(); // Evita que el clic se propague al document y cierre el menú
        toggleSortMenu();
    });

    // Cierra el menú si se hace clic fuera
    document.addEventListener('click', (e) => {
        if (!sortButton.contains(e.target) && !sortMenu.contains(e.target)) {
            sortMenu.classList.add('hidden');
            sortButton.setAttribute('aria-expanded', 'false'); // Actualiza el aria-expanded
        }
    });

    // Event listeners para cada opción del menú
    optionLastPurchase.addEventListener('click', (e) => {
        e.stopPropagation();
        sortButtonLabel.textContent = 'Últimas compras';
        sortMenu.classList.add('hidden');
        window.location.hash = 'page=1'; // <-- AÑADE ESTA LÍNEA
        applyAllFilters(); // <-- CAMBIA la función aquí
        selectOption('sort-menu', 'option-lastpurchase');
    });

    optionFirstPurchase.addEventListener('click', (e) => {
        e.stopPropagation();
        sortButtonLabel.textContent = 'Primeras compras';
        sortMenu.classList.add('hidden');
        window.location.hash = 'page=1'; // <-- AÑADE ESTA LÍNEA
        applyAllFilters(); // <-- CAMBIA la función aquí
        selectOption('sort-menu', 'option-firstpurchase');
    });

    optionAlphabetical.addEventListener('click', (e) => {
        e.stopPropagation();
        sortButtonLabel.textContent = 'Alfabético (A-Z)';
        sortMenu.classList.add('hidden');
        window.location.hash = 'page=1'; // <-- AÑADE ESTA LÍNEA
        applyAllFilters(); // <-- CAMBIA la función aquí
        selectOption('sort-menu', 'option-alphabetical');
    });

    optionAlphabeticalReverse.addEventListener('click', (e) => {
        e.stopPropagation();
        sortButtonLabel.textContent = 'Alfabético (Z-A)';
        sortMenu.classList.add('hidden');
        window.location.hash = 'page=1'; // <-- AÑADE ESTA LÍNEA
        applyAllFilters(); // <-- CAMBIA la función aquí
        selectOption('sort-menu', 'option-alphabetical-reverse');
    });

    optionNewest.addEventListener('click', (e) => {
        e.stopPropagation();
        sortButtonLabel.textContent = 'Más nuevos';
        sortMenu.classList.add('hidden');
        window.location.hash = 'page=1'; // <-- AÑADE ESTA LÍNEA
        applyAllFilters(); // <-- CAMBIA la función aquí
        selectOption('sort-menu', 'option-newest');
    });

    optionOldest.addEventListener('click', (e) => {
        e.stopPropagation();
        sortButtonLabel.textContent = 'Más antiguos';
        sortMenu.classList.add('hidden');
        window.location.hash = 'page=1'; // <-- AÑADE ESTA LÍNEA
        applyAllFilters(); // <-- CAMBIA la función aquí
        selectOption('sort-menu', 'option-oldest');
    });

    optionValueHigh.addEventListener('click', (e) => {
        e.stopPropagation();
        sortButtonLabel.textContent = 'Mayor valor';
        sortMenu.classList.add('hidden');
        window.location.hash = 'page=1'; // <-- AÑADE ESTA LÍNEA
        applyAllFilters(); // <-- CAMBIA la función aquí
        selectOption('sort-menu', 'option-value-high');
    });

    optionValueLow.addEventListener('click', (e) => {
        e.stopPropagation();
        sortButtonLabel.textContent = 'Menor valor';
        sortMenu.classList.add('hidden');
        window.location.hash = 'page=1'; // <-- AÑADE ESTA LÍNEA
        applyAllFilters(); // <-- CAMBIA la función aquí
        selectOption('sort-menu', 'option-value-low');
    });

    optionCostHigh.addEventListener('click', (e) => {
        e.stopPropagation();
        sortButtonLabel.textContent = 'Mayor coste';
        sortMenu.classList.add('hidden');
        window.location.hash = 'page=1'; // <-- AÑADE ESTA LÍNEA
        applyAllFilters(); // <-- CAMBIA la función aquí
        selectOption('sort-menu', 'option-cost-high');
    });

    optionCostLow.addEventListener('click', (e) => {
        e.stopPropagation();
        sortButtonLabel.textContent = 'Menor coste';
        sortMenu.classList.add('hidden');
        window.location.hash = 'page=1'; // <-- AÑADE ESTA LÍNEA
        applyAllFilters(); // <-- CAMBIA la función aquí
        selectOption('sort-menu', 'option-cost-low');
    });

 function toggleAllMenu() {
        allMenu.classList.toggle('hidden');
        // Asegúrate de cerrar otros menús
        if (typeof sortMenu !== 'undefined') sortMenu.classList.add('hidden');
        if (typeof platformMenu !== 'undefined') platformMenu.classList.add('hidden'); // Si tienes un menú de plataforma
        allButton.setAttribute('aria-expanded', allMenu.classList.contains('hidden') ? 'false' : 'true');
    }

    allButton.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleAllMenu();
    });

    document.addEventListener('click', (e) => {
        if (!allButton.contains(e.target) && !allMenu.contains(e.target)) {
            allMenu.classList.add('hidden');
            allButton.setAttribute('aria-expanded', 'false');
        }
    });

optionAll.addEventListener('click', (e) => {
        e.stopPropagation();
        allButtonLabel.textContent = 'Todo';
        allMenu.classList.add('hidden');
        // Antes: filterGamesByEdition('all');
        selectedEditionType = 'all'; // Nueva variable para almacenar la edición seleccionada
        selectOption('all-menu', 'option-all');
window.location.hash = 'page=1'; // <-- AÑADE ESTA LÍNEA
        applyAllFilters(); // Llamar a la función principal de filtros
    });

    optionBasic.addEventListener('click', (e) => {
        e.stopPropagation();
        allButtonLabel.textContent = 'Básica';
        allMenu.classList.add('hidden');
        // Antes: filterGamesByEdition('Básica');
        selectedEditionType = 'Básica'; // Almacenar la edición
        selectOption('all-menu', 'option-basic');
window.location.hash = 'page=1'; // <-- AÑADE ESTA LÍNEA
        applyAllFilters(); // Llamar a la función principal de filtros
    });

    optionReissue.addEventListener('click', (e) => {
        e.stopPropagation();
        allButtonLabel.textContent = 'Reedición';
        allMenu.classList.add('hidden');
        // Antes: filterGamesByEdition('Reedición');
        selectedEditionType = 'Reedición'; // Almacenar la edición
        selectOption('all-menu', 'option-reissue');
window.location.hash = 'page=1'; // <-- AÑADE ESTA LÍNEA
        applyAllFilters(); // Llamar a la función principal de filtros
    });

    optionSpecial.addEventListener('click', (e) => {
        e.stopPropagation();
        allButtonLabel.textContent = 'Especial';
        allMenu.classList.add('hidden');
        // Antes: filterGamesByEdition('Especial');
        selectedEditionType = 'Especial'; // Almacenar la edición
        selectOption('all-menu', 'option-special');
window.location.hash = 'page=1'; // <-- AÑADE ESTA LÍNEA
        applyAllFilters(); // Llamar a la función principal de filtros
    });

// --- Event Listeners para el botón y las opciones de plataforma ---

    function togglePlatformMenu() {
        platformMenu.classList.toggle('hidden');
        // Asegúrate de cerrar otros menús
        if (typeof sortMenu !== 'undefined') sortMenu.classList.add('hidden');
        if (typeof allMenu !== 'undefined') allMenu.classList.add('hidden');
        platformButton.setAttribute('aria-expanded', platformMenu.classList.contains('hidden') ? 'false' : 'true');
    }

    platformButton.addEventListener('click', (e) => {
        e.stopPropagation();
        togglePlatformMenu();
    });

    document.addEventListener('click', (e) => {
        if (!platformButton.contains(e.target) && !platformMenu.contains(e.target)) {
            platformMenu.classList.add('hidden');
            platformButton.setAttribute('aria-expanded', 'false');
        }
    });

    // Event listeners para cada opción del menú de plataforma
    platformOptionAll.addEventListener('click', (e) => {
        e.stopPropagation();
        // Desmarcar todas las demás opciones si "Todo" es seleccionado
        document.querySelectorAll('#platform-menu > div > div').forEach(option => {
            if (option.id !== 'platform-option-all' && option.textContent.startsWith('✓ ')) {
                option.textContent = option.textContent.replace('✓ ', '');
            }
        });
        selectedPlatforms = ['all']; // Solo "Todo"
        togglePlatformOption('platform-option-all', 'all'); // Esto lo marcará con ✓
        applyAllFilters();
    });

    platformOptionGBA.addEventListener('click', (e) => { e.stopPropagation(); togglePlatformOption('platform-option-gba', 'Game Boy Advance'); applyAllFilters(); });
    platformOption3DS.addEventListener('click', (e) => { e.stopPropagation(); togglePlatformOption('platform-option-3ds', 'Nintendo 3DS'); applyAllFilters(); });
    platformOptionDS.addEventListener('click', (e) => { e.stopPropagation(); togglePlatformOption('platform-option-ds', 'Nintendo DS'); applyAllFilters(); });
    platformOptionN64.addEventListener('click', (e) => { e.stopPropagation(); togglePlatformOption('platform-option-n64', 'Nintendo 64'); applyAllFilters(); });
    platformOptionSwitch.addEventListener('click', (e) => { e.stopPropagation(); togglePlatformOption('platform-option-switch', 'Nintendo Switch'); applyAllFilters(); });
    platformOptionWii.addEventListener('click', (e) => { e.stopPropagation(); togglePlatformOption('platform-option-wii', 'Nintendo Wii'); applyAllFilters(); });
    platformOptionWiiU.addEventListener('click', (e) => { e.stopPropagation(); togglePlatformOption('platform-option-wiiu', 'Nintendo Wii U'); applyAllFilters(); });
    platformOptionPS.addEventListener('click', (e) => { e.stopPropagation(); togglePlatformOption('platform-option-ps', 'PlayStation'); applyAllFilters(); });
    platformOptionPS2.addEventListener('click', (e) => { e.stopPropagation(); togglePlatformOption('platform-option-ps2', 'PlayStation 2'); applyAllFilters(); });
    platformOptionPS3.addEventListener('click', (e) => { e.stopPropagation(); togglePlatformOption('platform-option-ps3', 'PlayStation 3'); applyAllFilters(); });
    platformOptionPS4.addEventListener('click', (e) => { e.stopPropagation(); togglePlatformOption('platform-option-ps4', 'PlayStation 4'); applyAllFilters(); });
    platformOptionPS5.addEventListener('click', (e) => { e.stopPropagation(); togglePlatformOption('platform-option-ps5', 'PlayStation 5'); applyAllFilters(); });
    platformOptionX360.addEventListener('click', (e) => { e.stopPropagation(); togglePlatformOption('platform-option-x360', 'Xbox 360'); applyAllFilters(); });

let games = [];
let currentPage = 1; // <-- UNA sola declaración
const gamesPerPage = 48;

// --- Helper: leer página del hash ---
function getPageFromHash() {
  const hash = window.location.hash || '';
  const match = hash.match(/page=(\d+)/);
  if (match) return parseInt(match[1], 10);
  return null;
}

// --- Inicializar currentPage: prioridad hash > localStorage > 1 ---
function initCurrentPage() {
  const hashPage = getPageFromHash();
  const savedPage = parseInt(localStorage.getItem('currentPage'), 10);

  if (!isNaN(hashPage) && hashPage >= 1) {
    currentPage = hashPage;
  } else if (!isNaN(savedPage) && savedPage >= 1) {
    currentPage = savedPage;
  } else {
    currentPage = 1;
  }
}

// --- Finalizar inicialización de paginación cuando games ya esté listo ---
function finalizePaginationInit(initialLoad = true) {
  const totalPages = Math.max(1, Math.ceil(games.length / gamesPerPage));
  let hashPage = getPageFromHash();
  let wasOutOfRange = false;

  if (hashPage !== null && hashPage >= 1 && hashPage <= totalPages) {
    currentPage = hashPage; // Prioriza hash válido
  } else if (!initialLoad) {
    // Solo clampea fuera del rango si NO es la carga inicial
    if (currentPage > totalPages) {
      currentPage = totalPages;
      wasOutOfRange = true;
    } else if (currentPage < 1) {
      currentPage = 1;
      wasOutOfRange = true;
    }
  } else {
    // En carga inicial, no hacemos clamp para respetar #page aunque no haya tantos juegos
    if (currentPage < 1) currentPage = 1; // por seguridad
  }

  if (!window.location.hash || wasOutOfRange) {
    history.replaceState(null, '', `#page=${currentPage}`);
  }

  localStorage.setItem('currentPage', currentPage);
  renderGamesPage(currentPage);
  renderPagination();
}

// --- Escuchar cambios de hash (back/forward y clicks) ---
window.addEventListener('hashchange', () => {
  const p = getPageFromHash();
  if (!isNaN(p) && p >= 1 && p !== currentPage) {
    currentPage = p;
    localStorage.setItem('currentPage', currentPage);
    renderGamesPage(currentPage);
    renderPagination();
  }
});

// INICIALIZAR currentPage ahora (antes de cargar juegos)
initCurrentPage();


// ✅ FUNCIÓN PARA CARGAR JUEGOS
function renderGamesFromFirebase() {
  db.collection('games').get().then(snapshot => {
    gamesContainer.innerHTML = "";
    games = [];
    originalGamesOrder = [];

    snapshot.forEach((doc) => {
      const data = doc.data();

      const gameData = {
        id: doc.id,
        title: data.title,
        value: data.value,
        link: data.link,
        image: (data.imageURL || "").trim() !== ""
          ? data.imageURL
          : "https://via.placeholder.com/158x158?text=Sin+Imagen",
        platform: data.platform || "",
        folder: data.folder,
        condition: data.condition,
        rating: data.rating,
        purchaseDate: data.purchaseDate,
        releaseDate: data.releaseDate,
        purchaseLocation: data.purchaseLocation,
        region: data.region,
        gift: data.gift,
        cost: data.cost,
        edition: data.edition,
        wallapopLink: data.wallapopLink,
        vintedLink: data.vintedLink,
        ebayLink: data.ebayLink,
        cex: data.cex,
        cexLink: data.cexLink,
        estado: data.estado,
        details: data.details,
      };

      originalGamesOrder.push(gameData); // Guardar el orden original
    });

    // Inicializar selectedPlatforms con 'all' y marcar la opción 'Todo' por defecto
selectedPlatforms = ['all'];
if (platformOptionAll && !platformOptionAll.textContent.startsWith('✓ ')) {
    platformOptionAll.textContent = '✓ ' + platformOptionAll.textContent;
}
platformButtonLabel.textContent = 'Todo';

// --- CÓDIGO CLAVE PARA LA ORDENACIÓN DE INICIO ---

// 1. Establecer la variable de ordenación por defecto
//    (Si usas una variable para esto, aunque tu código lea del textContent)
//    selectedSortType = 'lastpurchase';

// 2. Marcar visualmente la opción "Últimas compras"
selectOption('sort-menu', 'option-lastpurchase');
sortButtonLabel.textContent = 'Últimas compras';

// 3. Establecer la opción "Todo" de edición como seleccionada
selectedEditionType = 'lastpurchase'; 
selectOption('all-menu', 'option-all');
allButtonLabel.textContent = 'Todo';

// 4. Aseguramos que `games` contiene los datos cargados
games = originalGamesOrder.slice();

// 5. ¡Ejecutar la función que aplica todos los filtros y la ordenación!
//    Esto ordenará la lista de juegos según lo que has puesto en sortButtonLabel.textContent
applyAllFilters();

// Llamar a applyAllFilters y, si es asíncrona, esperar su resolución
const maybePromise = applyAllFilters && applyAllFilters();

if (maybePromise && typeof maybePromise.then === 'function') {
  maybePromise.then(() => {
    finalizePaginationInit(true);  // <-- Aquí pasamos 'true'
  }).catch(err => {
    console.error('applyAllFilters fallo:', err);
    finalizePaginationInit(true); // también aquí
  });
} else {
  finalizePaginationInit(true); // y aquí
}


  });
}

const searchInput = document.getElementById('searchInput');

searchInput.addEventListener('input', function () {
  const filter = searchInput.value.trim().toLowerCase();
  currentSearchTerm = filter;

  if (filter === "") {
    // Si la barra está vacía, aplica filtros y reinicia todo
    applyFiltersAndReset();
    return;
  }

  // Si hay texto, filtramos y ordenamos con la nueva función (incluyendo búsqueda)
  const filteredGamesBySearch = getFilteredGames();

  currentPage = 1;
    window.location.hash = `page=${currentPage}`;  // <-- actualizar URL
  renderFilteredGames(filteredGamesBySearch);
  updateCollectionSummary(filteredGamesBySearch);  // Aquí pasamos la lista filtrada (aunque vacía)
  document.getElementById('pagination').innerHTML = "";
});




function renderFilteredGames(filteredGames) {
  gamesContainer.innerHTML = "";

  filteredGames.forEach(game => {
    const card = document.createElement("a");
    card.className = "mx-auto my-1 w-[176px]";
    card.href = "#";
    card.style.display = "block";
    card.dataset.cost = game.cost || 0;
    card.dataset.value = game.value || 0;

    let imageHeight = 154;

    const specialTitleHeights = {
      "Little Nightmares II [Edición TV]": 110,
      "Bonus Demo 8 (You) + Network Access Disc": 130,
    };

    const specialPlatformHeights = ["Nintendo DS", "Nintendo 3DS", "PlayStation", "Game Boy Advance"];

    if (specialTitleHeights[game.title]) {
      imageHeight = specialTitleHeights[game.title];
    } else if (specialPlatformHeights.includes(game.platform)) {
      imageHeight = 130;
    }

    const imgStyle = `color: transparent; height: ${imageHeight}px; width: auto;`;

    card.innerHTML = `
      <div class="text-card-foreground border shadow-md p-2 duration-200 ease-in-out"
        style="background-color: rgba(242, 249, 255, 1); border-radius: 0.5rem;"
        onmouseover="this.style.backgroundColor='rgba(230, 245, 255, 1)';"
        onmouseout="this.style.backgroundColor='rgba(242, 249, 255, 1)';">
        <div class="flex flex-col space-y-1.5 p-0">
          <div class="flex flex-col">
            <div class="grid h-[158px]">
              <div class="col-start-1 row-start-1 w-full flex justify-center items-center" style="height: 154px;">
                <img alt="${game.title}" loading="lazy" decoding="async"
                  height="${imageHeight}" src="${game.image}" class="rounded-sm text-center bg-primary/10"
                  style="${imgStyle}">
              </div>
            </div>
          </div>
        </div>
        <div class="p-0">
          <div class="bg-border shrink-0 h-[1px] w-full mb-1 mt-1"></div>
          <div role="progressbar" class="bg-blue-300 relative h-4 w-full overflow-hidden rounded-full mt-1.5">
            <div class="dark:bg-primary h-full w-full flex-1 bg-black transition-all" style="transform: translateX(0%);"></div>
            <div class="absolute inset-0 flex items-center justify-center">
              <span class="text-xs font-medium text-white mix-blend-difference">
                ${(() => {
                  const num = Number(game.value) || 0;
                  const [intPart, decimals] = num.toFixed(2).split('.');
                  return decimals === '00' ? `${intPart}€` : `${intPart},${decimals}€`;
                })()}
              </span>
            </div>
          </div>
        </div>
      </div>
    `;

    card.addEventListener("click", (e) => {
      e.preventDefault();
      openModal(games.indexOf(game)); // Abrir modal con índice real
    });

    gamesContainer.appendChild(card);
  });
}


function renderGamesPage(page) {
  gamesContainer.innerHTML = "";

  const startIndex = (page - 1) * gamesPerPage;
  const endIndex = startIndex + gamesPerPage;
  const gamesToRender = games.slice(startIndex, endIndex);

  gamesToRender.forEach((game, index) => {
    const card = document.createElement("a");
    card.className = "mx-auto my-1 w-[176px]";
    card.href = "#";
    card.style.display = "block";

    let imageHeight = 154; // Valor por defecto

    // Títulos específicos con altura especial
    const specialTitleHeights = {
      "Little Nightmares II [Edición TV]": 110,
      "Bonus Demo 8 (You) + Network Access Disc": 130,
    };

    // Plataformas con altura especial
    const specialPlatformHeights = ["Nintendo DS", "Nintendo 3DS", "PlayStation", "Game Boy Advance"];

    if (specialTitleHeights[game.title]) {
      imageHeight = specialTitleHeights[game.title];
    } else if (specialPlatformHeights.includes(game.platform)) {
      imageHeight = 130;
    }

    const imgStyle = `color: transparent; height: ${imageHeight}px; width: auto;`;

    card.innerHTML = `
      <div class="text-card-foreground border shadow-md p-2 duration-200 ease-in-out"
        style="background-color: rgba(242, 249, 255, 1); border-radius: 0.5rem;"
        onmouseover="this.style.backgroundColor='rgba(230, 245, 255, 1)';"
        onmouseout="this.style.backgroundColor='rgba(242, 249, 255, 1)';">
        <div class="flex flex-col space-y-1.5 p-0">
          <div class="flex flex-col">
            <div class="grid h-[158px]">
              <div class="col-start-1 row-start-1 w-full flex justify-center items-center" style="height: 154px;">
                <img alt="${game.title}" loading="lazy" decoding="async"
                  height="${imageHeight}" src="${game.image}" class="rounded-sm text-center bg-primary/10"
                  style="${imgStyle}">
              </div>
            </div>
          </div>
        </div>
        <div class="p-0">
          <div class="bg-border shrink-0 h-[1px] w-full mb-1 mt-1"></div>
          <div role="progressbar" class="bg-blue-300 relative h-4 w-full overflow-hidden rounded-full mt-1.5">
            <div class="dark:bg-primary h-full w-full flex-1 bg-black transition-all" style="transform: translateX(0%);"></div>
            <div class="absolute inset-0 flex items-center justify-center">
              <span class="text-xs font-medium text-white mix-blend-difference">
                ${(() => {
                  const num = Number(game.value) || 0;
                  const [intPart, decimals] = num.toFixed(2).split('.');
                  return decimals === '00' ? `${intPart}€` : `${intPart},${decimals}€`;
                })()}
              </span>
            </div>
          </div>
        </div>
      </div>
    `;

    const globalIndex = startIndex + index;
    card.addEventListener("click", (e) => {
      e.preventDefault();
      openModal(globalIndex);
    });

    gamesContainer.appendChild(card);
  });
}

function renderPagination() {
  const pagination = document.getElementById('pagination');
  const totalPages = Math.ceil(games.length / gamesPerPage);
  let html = `<nav role="navigation" aria-label="pagination" class="mx-auto flex w-full justify-center"><ul class="flex flex-row items-center gap-1">`;

  const createPageLink = (page, active = false) => `
    <li>
      <a 
        href="#page=${page}"
        class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-70 ${active ? 'border border-input bg-background shadow-sm' : 'hover:bg-accent hover:text-accent-foreground'} h-9 p-2.5 lg:p-3"
        data-page="${page}"
      >
        ${page}
      </a>
    </li>
  `;

  const addDots = () => `<li class="px-1 text-gray-500">...</li>`;

  const pages = [];

  if (totalPages <= 4) {
    for (let i = 1; i <= totalPages; i++) {
      pages.push(i);
    }
  } else {
    if (currentPage <= 2) {
      pages.push(1, 2, 3, 'dots', totalPages);
    } else if (currentPage >= totalPages - 1) {
      pages.push(totalPages - 2, totalPages - 1, totalPages);
    } else {
      pages.push(currentPage - 1, currentPage, currentPage + 1, 'dots', totalPages);
    }
  }

  // Añadir enlaces
  for (let i = 0; i < pages.length; i++) {
    if (pages[i] === 'dots') {
      html += addDots();
    } else {
      html += createPageLink(pages[i], pages[i] === currentPage);
    }
  }

  html += `</ul></nav>`;
  pagination.innerHTML = html;

// Manejador de clicks: solo actualizar hash — el listener 'hashchange' hará el render y localStorage
document.querySelectorAll('#pagination a').forEach(a => {
  a.addEventListener('click', (e) => {
    e.preventDefault();
    const selectedPage = parseInt(a.dataset.page, 10);
    if (!isNaN(selectedPage) && selectedPage !== currentPage) {
      // Cambiamos solo el hash; esto genera evento 'hashchange' que hará render + guardado
      window.location.hash = `page=${selectedPage}`;
    }
  });
});
}

  auth.onAuthStateChanged(user => {
    updateAuthStatusIcon(user);
    if (!user && typeof form !== 'undefined') {
      form.classList.add('hidden');
    }

    // ✅ Llama aquí a renderGamesFromFirebase para asegurar que se ejecuta tras autenticar o no
    renderGamesFromFirebase();
  });

function showFullscreenImage(imageUrl) {
  fullscreenImageView.src = imageUrl;
  fullscreenImageModal.classList.add('active'); // Muestra el overlay y activa la animación

  // Bloquear el scroll del fondo de manera segura
  document.documentElement.classList.add('no-scroll');
}

function hideFullscreenImage() {
  fullscreenImageModal.classList.remove('active'); // Oculta el overlay y activa la animación inversa

  // Restaurar el scroll del fondo
  document.documentElement.classList.remove('no-scroll');
}


function openEditModal(game) {
  console.log("Abriendo modal de edición", game)
  const overlay = document.getElementById('modalOverlay');
  const form = document.getElementById('gameForm');
  const editBtn = document.getElementById("editBtn");

  
  document.getElementById('guardarSubmit').textContent = 'Actualizar';

  
// Mostrar modal con animación garantizada
overlay.classList.remove('hidden'); // Hace el elemento "visible" para el navegador
overlay.style.display = 'flex';    // Forza el display antes de animar

setTimeout(() => { // Da un respiro mínimo al navegador para que procese el cambio
    overlay.classList.add('visible');
    form.classList.add('visible');
}, 10); // 10 milisegundos es suficiente



  // Rellenar los campos del formulario con los datos del juego
  document.getElementById('imageUrl').value = game.image || '';
  document.getElementById('title').value = game.title || '';
  document.getElementById('platform').value = game.platform || '';
  document.getElementById('folder').value = game.folder || '';
  document.getElementById('condition').value = game.condition || '';
  document.getElementById('purchaseDate').value = game.purchaseDate || '';
  document.getElementById('releaseDate').value = game.releaseDate || '';
  document.getElementById('purchaseLocation').value = game.purchaseLocation || '';
  document.getElementById('region').value = game.region || '';
  document.getElementById('gift').value = game.gift || '';
  document.getElementById('cost').value = game.cost || '';
  document.getElementById('edition').value = game.edition || '';
  document.getElementById('value').value = game.value || '';
  document.getElementById('wallapopLink').value = game.wallapopLink || '';
  document.getElementById('vintedLink').value = game.vintedLink || '';
  document.getElementById('ebayLink').value = game.ebayLink || '';
  document.getElementById('cex').value = game.cex || '';
  document.getElementById('cexLink').value = game.cexLink || '';
  document.getElementById('details').value = game.details || '';

  // ⭐ Rellenar las estrellas
  const stars = document.querySelectorAll('#estadoStars span');
  stars.forEach(star => {
    const starValue = parseInt(star.getAttribute('data-star'));
    star.classList.toggle('active', starValue <= (parseInt(game.estado) || 0));
  });

  // **IMPORTANTE: Guardar el ID del juego para actualizarlo luego**
  form.dataset.gameId = game.id;
}

const form = document.getElementById('gameForm');

const closeForm = (resetGameId = true, forceReload = false) => {
    const overlay = document.getElementById('modalOverlay');
    const form = document.getElementById('gameForm');

    // 1. Inicia la animación de salida quitando clases
    form.classList.remove('visible');
    form.classList.remove('opacity-100');
    overlay.classList.remove('visible');
    overlay.classList.remove('opacity-100');

    // 2. Después de la animación, oculta y resetea todo
    setTimeout(() => {
        overlay.style.display = 'none';
        overlay.classList.remove('flex');

        form.reset();

        // ✅ Reactiva el botón de guardar
        form.querySelector('#guardarSubmit').disabled = false;

        // ✅ Usa el parámetro correctamente
        if (resetGameId) {
            delete form.dataset.gameId;
            form.querySelector('#guardarSubmit').textContent = 'Guardar';
        }

        if (forceReload) {
            renderGamesFromFirebase(); // ✅ Esto sí se ejecutará ahora
        }
    }, 300);
};
const modalOverlay = document.getElementById('modalOverlay');

modalOverlay.addEventListener('click', (event) => {
  if (event.target === modalOverlay) {
    closeForm(false, false); // ❌ no recarga al cerrar con clic fuera
  }
});

form.addEventListener('submit', async function handleSubmit(e) {
  e.preventDefault();
  
  // Desactiva temporalmente el submit
  form.querySelector('#guardarSubmit').disabled = true;

  const gameId = form.dataset.gameId;
  const updatedGame = {
    imageURL: form.imageUrl.value,
    title: form.title.value,
    platform: form.platform.value,
    folder: form.folder.value,
    condition: form.condition.value,
    purchaseDate: form.purchaseDate.value,
    releaseDate: form.releaseDate.value,
    purchaseLocation: form.purchaseLocation.value,
    region: form.region.value,
    gift: form.gift.value,
    cost: parseFloat(form.cost.value) || 0,
    edition: form.edition.value,
    value: parseFloat(form.value.value) || 0,
    wallapopLink: form.wallapopLink.value,
    vintedLink: form.vintedLink.value,
    ebayLink: form.ebayLink.value,
    cex: parseFloat(form.cex.value) || 0,
    cexLink: form.cexLink.value,
    estado: document.querySelectorAll('#estadoStars span.active').length,
    details: form.details.value,
  };

  try {
if (gameId) {
  await db.collection('games').doc(gameId).update(updatedGame);
  alert("Juego actualizado correctamente");
  closeForm(true, true); // ✅ Esto debe estar dentro del if
} else {
  await db.collection('games').add(updatedGame);
  alert("Juego añadido correctamente");
  closeForm(true, true); // ✅ También aquí
}
  } catch (error) {
    console.error("Error guardando el juego:", error);
    alert("Error al guardar los cambios.");
    form.querySelector('#guardarSubmit').disabled = false;
  }
});


document.getElementById('deleteBtn').addEventListener('click', () => {
  const modal = document.getElementById("modal");
  const index = parseInt(modal.dataset.currentIndex);

  if (!isNaN(index) && games[index]) {
    const game = games[index];
    const confirmDelete = confirm(`¿Seguro que quieres eliminar el juego "${game.title}"?`);

    if (confirmDelete) {
      db.collection('games').doc(game.id).delete()
        .then(() => {
          alert("Juego eliminado correctamente");
          modal.classList.add("hidden");
          renderGamesFromFirebase();
        })
        .catch((error) => {
          console.error("Error al eliminar el juego:", error);
          alert("Error al eliminar el juego.");
        });
    }
  }
});


function openAddModal() {
  const overlay = document.getElementById('modalOverlay');
  const form = document.getElementById('gameForm');
  
  if (overlay.classList.contains('visible')) return; // Evita reabrir si ya está abierto


  form.reset();                  // Limpia todos los campos del formulario
  delete form.dataset.gameId;    // Elimina el gameId para indicar que es un juego nuevo (no editar)

  document.getElementById('guardarSubmit').textContent = 'Guardar';

  overlay.classList.add('visible');
  overlay.classList.remove('hidden');
  form.classList.add('visible');
  form.classList.remove('opacity-0');

  document.body.classList.add("no-scroll"); // Bloquear scroll

}

let scrollPosition = 0; // Variable para almacenar la posición de scroll

function openModal(index) {
  console.log("Valor de games al abrir el modal:", games); // Añade esta línea
  const game = games[index];
  const modal = document.getElementById("modal");
  const modalImage = document.getElementById("modalImage");
  const modalDetails = document.getElementById("modalDetails");
  const modalButtons = document.getElementById('modalButtons');
  const user = firebase.auth().currentUser;


  
  modal.dataset.currentIndex = index; // 👈 Esto es clave

  if (user) {
    modalButtons.classList.remove('hidden');
  } else {
    modalButtons.classList.add('hidden');
  }

const modalHeader = document.getElementById('modalHeader');
  modalHeader.innerHTML = `
    <h2 class="text-gray-800 text-center" style="font-weight: bold; font-size: 1.1rem;">${game.title}</h2>
  `;

modalImage.src = game.image;

  // ✅ Nuevo bloque para ajustar el tamaño y centrado de la imagen
  let imageHeightModal = 430; // Valor por defecto

if (game.title === "Little Nightmares II [Edición TV]") {
  imageHeightModal = 330; // Altura específica para Little Nightmares II
} else if (
  game.title === "Bonus Demo 8 (You) + Network Access Disc" ||
  game.platform === "Nintendo DS" ||
  game.platform === "Nintendo 3DS" ||
  game.platform === "PlayStation" ||
  game.platform === "Game Boy Advance"
) {
  imageHeightModal = 330; // Altura para Bonus Demo 8 y otras plataformas específicas
}
// Si no coincide con ninguna de las condiciones anteriores, se mantendrá en 430 (el valor por defecto)
  modalImage.style.height = `${imageHeightModal}px`;
  modalImage.style.width = 'auto'; // Mantiene la proporción
  modalImage.style.display = 'block'; // Para poder usar margin auto
  modalImage.style.marginLeft = 'auto';
  modalImage.style.marginRight = 'auto';
  modalImage.style.marginBottom = '2rem'; // Añade un poco de espacio debajo de la imagen
  modalImage.style.objectFit = 'contain'; // Asegura que la imagen se ajuste sin recortar

  // 3. Evento clic en la carátula dentro del modal principal (dentro de openModal)
  if (modalImage) { // Comprobación por si modalImage no existe aún
    modalImage.onclick = () => { // Usamos onclick directamente para evitar múltiples listeners
      const imageUrl = modalImage.src; 
      if (imageUrl) {
        showFullscreenImage(imageUrl);
      }
    };
  }

  function formatMoney(value) {
  const num = Number(value) || 0;
  const [intPart, decimals] = num.toFixed(2).split('.');
  return decimals === '00' ? `${intPart}€` : `${intPart},${decimals}€`;
}


const formatDate = (dateString) => {
  if (!dateString) return ''; // Or you might want to return a default string like '--'

  const date = new Date(dateString);
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
  const year = date.getFullYear();

  return `${day}-${month}-${year}`;
};

const conditionAndState = (game.condition || game.estado)
  ? `<div class="mb-2 flex items-center gap-2">
      ${game.condition ? `<span title="Condición" class="condition-span custom-text-gray-800">📦&nbsp;<span class="custom-text-gray-800" style="margin-left: 0.28em; display: inline-block;">${game.condition}</span></span>` : ''}
      ${game.estado ? `<span class="estado-span custom-text-gray-800" style="margin-left: 0.3em; display: inline-block;">(${'★'.repeat(parseInt(game.estado))}&nbsp;<span class="custom-text-gray-800">${parseInt(game.estado)}/5)</span></span>` : ''}
    </div>`
  : '';

const column1 = [];
const column2 = [];

// Elementos fijos
if (game.platform) column1.push({ icon: '🎮', label: game.platform, title: 'Plataforma' });
if (game.region) column1.push({ icon: '🌍', label: game.region, title: 'Región' });
column1.push('CONDICION_ESTADO_PLACEHOLDER');
if (game.purchaseDate) column2.push({ icon: '🛒', label: formatDate(game.purchaseDate), title: 'Fecha de compra' });
if (game.releaseDate) column2.push({ icon: '🆕', label: formatDate(game.releaseDate), title: 'Fecha de lanzamiento' });
if (game.folder) column2.push({ icon: '📂', label: game.folder, title: 'Carpeta' });

// Elementos condicionales
if (game.gift) {
    column2.push({ icon: '🎁', label: game.gift, title: 'Regalo' });

    if (game.purchaseLocation) {
        column1.push({ icon: '📍', label: game.purchaseLocation, title: 'Lugar de compra' });
    }
    if (game.edition) {
        const editionLabel = game.edition === 'Reedición (Platinum, etc)' ? 'Reedición' : game.edition;
        column1.push({ icon: '🗃️', label: editionLabel, title: 'Edición' });

    }
    
} else {
    if (game.edition) {
        const editionLabel = game.edition === 'Reedición (Platinum, etc)' ? 'Reedición' : game.edition;
        column1.push({ icon: '🗃️', label: editionLabel, title: 'Edición' });

    }

    if (game.purchaseLocation) {
        column2.push({ icon: '📍', label: game.purchaseLocation, title: 'Lugar de compra' });
    }
}


// ... (Las funciones formatDate, renderColumn, etc. permanecen igual)

  const renderColumn = (items) =>
      items.filter(Boolean).map((item) => {
    if (item === 'CONDICION_ESTADO_PLACEHOLDER') {
      return conditionAndState;
    }
    if (item.link) {
      return `<div class="mb-2 flex items-center gap-2">
        <a href="${item.link}" target="_blank" class="flex items-center gap-1"><span style="margin-right: 0.3em;">${item.icon}</span><span class="underline custom-text-gray-800">${item.label}</span></a>
      </div>`;
    }
    return `<div class="mb-2 flex items-center gap-2">
      <span title="${item.title || ''}" style="margin-right: 0.3em;">${item.icon}</span><span style="margin-left: 0.3em;" class="custom-text-gray-800">${item.label}</span>
    </div>`;
    }).join('');

modalDetails.innerHTML = `
  <div class="mt-6 mb-6 bg-gray-300 h-[1px] w-full mt-2 rounded" style="background-color: #D1D5DB !important; height: 1px !important;"></div>
  <div class="custom-grid-md-2 custom-gap-6 custom-mb-6">
    <div class="custom-pr-4">
      ${renderColumn(column1)}
    </div>
    <div class="custom-pr-4">
      ${renderColumn(column2)}
    </div>
  </div>

  <div class="custom-bg-gray custom-p-6 custom-rounded-lg custom-shadow-inner custom-mt-6 custom-flex custom-flex-col items-center">
  <h3 class="text-gray-800 text-2xl font-bold mb-4 text-center">Precios</h3>
  <div class="flex flex-col items-center w-full mb-4">

    <p class="${Number(game.value) > Number(game.cost) ? 'custom-text-green-700' : 'custom-text-red-500'} text-2xl font-bold">
      VALOR: <span id="modal-value">${formatMoney(game.value)}</span>
    </p>
    <p class="custom-text-gray-700" text-lg">
      COSTO: <span id="modal-cost" class="custom-text-gray-700">${formatMoney(game.cost)}</span>
    </p>
    <p class="custom-text-gray-700" text-lg">
      CEX: <span id="modal-cex">${formatMoney(game.cex)}</span>
    </p>

  </div>

  <div class="mt-4 flex justify-center gap-x-4 flex-wrap">
  ${game.wallapopLink ? `
    <a id="modal-wallapop-link" href="${game.wallapopLink}" target="_blank" class="flex items-center px-2 hover:underline">
      <img src="https://i.ibb.co/RpbCN10H/217439.png" alt="Wallapop" class="custom-icon-shadow" style="width: 32px; height: 32px;">
    </a>` : ''}
  ${game.vintedLink ? `
    <a id="modal-vinted-link" href="${game.vintedLink}" target="_blank" class="flex items-center px-2 hover:underline">
      <img src="https://i.ibb.co/gY2Tqd5/217438.png" alt="Vinted" class="custom-icon-shadow" style="width: 32px; height: 32px;">
    </a>` : ''}
  ${game.ebayLink ? `
    <a id="modal-ebay-link" href="${game.ebayLink}" target="_blank" class="flex items-center px-2 hover:underline">
      <img src="https://i.ibb.co/67Mcg0Qd/217436.png" alt="eBay" class="custom-icon-shadow" style="width: 32px; height: 32px;">
    </a>` : ''}
  ${game.cexLink ? `
    <a id="modal-cex-link" href="${game.cexLink}" target="_blank" class="flex items-center px-2 hover:underline">
      <img src="https://i.ibb.co/kg4KSbJX/217437.png" alt="Cex" class="custom-icon-shadow" style="width: 32px; height: 32px;">
    </a>` : ''}
</div>
</div>



  ${game.details ? `
      <div class="custom-mt-6 custom-p-4 custom-bg-blue-50 custom-rounded-lg">
    <div class="custom-flex custom-items-center custom-justify-between">
      <h3 class="custom-text-blue-800 custom-text-xl custom-font-semibold custom-mb-2">
        Detalles adicionales
      </h3>
      <button id="read-details-btn" aria-label="Leer detalles en voz alta">
        <div id="read-details-icon" style="width:15px; height:15px;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="-10 16 35 75" width="17" height="17" class="custom-text-blue-800" overflow="visible">
            <path d="M39.389,13.769 L22.235,28.606 L6,28.606 L6,47.699 L21.989,47.699 L39.389,62.75 L39.389,13.769z" 
                  style="stroke:currentColor;stroke-width:5;stroke-linejoin:round;fill:currentColor;" />
            <path d="M48,27.6a19.5,19.5 0 0 1 0,21.4M55.1,20.5a30,30 0 0 1 0,35.6M61.6,14a38.8,38.8 0 0 1 0,48.6" 
                  style="fill:none;stroke:currentColor;stroke-width:5;stroke-linecap:round" />
          </svg>
        </div>
      </button>
    </div>
    <p id="modal-details" class="custom-text-blue-800 custom-text-sm custom-leading-relaxed">${game.details}</p>
  </div>
  ` : ''}
`;

function svgOriginal() {
  return `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="-10 16 35 75" width="17" height="17" class="custom-text-blue-800" overflow="visible">
      <path d="M39.389,13.769 L22.235,28.606 L6,28.606 L6,47.699 L21.989,47.699 L39.389,62.75 L39.389,13.769z" 
            style="stroke:currentColor;stroke-width:5;stroke-linejoin:round;fill:currentColor;" />
      <path d="M48,27.6a19.5,19.5 0 0 1 0,21.4M55.1,20.5a30,30 0 0 1 0,35.6M61.6,14a38.8,38.8 0 0 1 0,48.6" 
            style="fill:none;stroke:currentColor;stroke-width:5;stroke-linecap:round" />
    </svg>
  `;
}

const btnLeer = document.getElementById('read-details-btn');
const icono = document.getElementById('read-details-icon');

// Detectar iOS
const esIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
(navigator.userAgent.includes("Macintosh") && 'ontouchend' in document);

// Ocultar botón si no hay soporte de voz o si es iOS
if (
  !window.speechSynthesis ||
  typeof SpeechSynthesisUtterance === 'undefined' ||
  esIOS
) {
  if (btnLeer) btnLeer.style.display = 'none';
} else {
  const vocesDisponibles = speechSynthesis.getVoices();
  if (vocesDisponibles.length === 0) {
    // Si las voces aún no están cargadas, esperar evento
    speechSynthesis.addEventListener('voiceschanged', () => {
      if (speechSynthesis.getVoices().length === 0 && btnLeer) {
        btnLeer.style.display = 'none';
      }
    }, { once: true });
  }
}

let hablando = false;
let mensajeActual = null;

if (btnLeer && icono) {
  btnLeer.addEventListener('click', () => {
    if (hablando) {
      speechSynthesis.cancel();
      icono.innerHTML = svgOriginal();
      hablando = false;
      return;
    }

    const texto = document.getElementById('modal-details')?.innerText;
    if (!texto) return;

    mensajeActual = new SpeechSynthesisUtterance(texto);
    mensajeActual.lang = 'es-AR';
    mensajeActual.rate = 1.5;

    const establecerVoz = () => {
  const voces = speechSynthesis.getVoices();
  // Buscar la voz específica de Windows
  let vozSeleccionada = voces.find(v => v.name === "Microsoft Elena Online (Natural) - Spanish (Argentina)");

  // Si no está disponible, buscar la primera voz femenina en español
  if (!vozSeleccionada) {
    vozSeleccionada = voces.find(v =>
      v.lang.startsWith('es') &&
      (v.name.toLowerCase().includes('female') || v.name.toLowerCase().includes('mujer'))
    );

    // Si aún no se encuentra, tomar la primera voz en español disponible
    if (!vozSeleccionada) {
      vozSeleccionada = voces.find(v => v.lang.startsWith('es'));
    }
  }

  if (vozSeleccionada) {
    mensajeActual.voice = vozSeleccionada;
  }

  speechSynthesis.cancel();
  speechSynthesis.speak(mensajeActual);
};

    mensajeActual.onstart = () => {
      hablando = true;
      icono.innerHTML = `
  <svg 
    id="svg-hablando"
    xmlns="http://www.w3.org/2000/svg" 
    viewBox="8 4 74 32" 
    width="15" 
    height="15" 
    class="custom-text-blue-800" 
    style="overflow: visible; background-color: transparent; display: block;"
  >
    <circle cx="20" cy="20" r="12" fill="#1e40af" opacity="0.4">
      <animate attributeName="opacity" values="0.4;1;0.4" dur="1.5s" repeatCount="indefinite" begin="0s"/>
      <animate attributeName="r" values="12;16;12" dur="1.5s" repeatCount="indefinite" begin="0s"/>
    </circle>
    <circle cx="50" cy="20" r="12" fill="#1e40af" opacity="0.4">
      <animate attributeName="opacity" values="0.4;1;0.4" dur="1.5s" repeatCount="indefinite" begin="0.5s"/>
      <animate attributeName="r" values="12;16;12" dur="1.5s" repeatCount="indefinite" begin="0.5s"/>
    </circle>
    <circle cx="80" cy="20" r="12" fill="#1e40af" opacity="0.4">
      <animate attributeName="opacity" values="0.4;1;0.4" dur="1.5s" repeatCount="indefinite" begin="1s"/>
      <animate attributeName="r" values="12;16;12" dur="1.5s" repeatCount="indefinite" begin="1s"/>
    </circle>
  </svg>
`;


    };

    mensajeActual.onend = () => {
      hablando = false;
      icono.innerHTML = svgOriginal();
    };

    mensajeActual.onerror = () => {
      hablando = false;
      icono.innerHTML = svgOriginal();
    };

    if (speechSynthesis.getVoices().length === 0) {
  speechSynthesis.addEventListener('voiceschanged', establecerVoz, { once: true });
} else {
  establecerVoz();
}

  });
}





modal.addEventListener('click', (event) => {
    if (event.target === modal) {
      closeModal();
    }
  });

  function closeModal() {
  const modal = document.getElementById('modal');
  modal.classList.remove('flex');
  document.documentElement.classList.remove('no-scroll');  // ⬅️ Esta línea restaura el scroll del fondo
  setTimeout(() => {
    modal.style.display = 'none';
        // Limpia el formulario y borra gameId para que se reinicie al abrir
    closeForm(true);
  }, 200);
}


  const closeModalButton = document.getElementById('closeModalBtn');
    if (closeModalButton) {
      closeModalButton.onclick = closeModal;
    }

  modal.style.display = 'flex';
  document.documentElement.classList.add('no-scroll'); // ⬅️ Esta línea evita que se mueva el fondo
  setTimeout(() => modal.classList.add('flex'), 10);
}

// 4. Eventos globales para el modal de imagen en pantalla completa (fuera de openModal, dentro de DOMContentLoaded)
if (fullscreenImageModal) {
  fullscreenImageModal.addEventListener('click', (event) => {
    if (event.target === fullscreenImageModal) {
      hideFullscreenImage();
    }
  });
}

document.addEventListener('keydown', (event) => {
  if (event.key === 'Escape' && fullscreenImageModal.classList.contains('active')) {
    hideFullscreenImage();
  }
});
// --- FIN DEL CÓDIGO A AÑADIR ---

  authStatusBtn.onclick = () => {
  if (isAuthenticated) {
    auth.signOut().then(() => alert('Sesión cerrada'));
  } else {
    showLoginModal(); // ✅ Usa tu función animada
  }
  };

  loginSubmit.onclick = () => {
    const email = loginEmail.value.trim();
    const password = loginPassword.value.trim();

    if (!email || !password) {
      alert('Introduce correo y contraseña');
      return;
    }

    auth.signInWithEmailAndPassword(email, password)
      .then(() => {
        hideLoginModal(); // ✅ Usa función animada
        loginModal.classList.add('hidden');
        loginModal.classList.remove('login-error');
        if (typeof form !== 'undefined') {
          form.classList.remove('hidden');
          
        }
      })
      .catch(() => {
        loginModal.classList.add('login-error');
      });
      
  };

  logoutButton.onclick = () => {
    loginModal.classList.add('hidden');
    loginModal.classList.remove('login-error');
  };

  loginModal.onclick = (e) => {
    if (e.target === loginModal) {
      loginModal.classList.add('hidden');
      loginModal.classList.remove('login-error');
      hideLoginModal();
    }
  };

// Mostrar modal con animación
function showLoginModal() {
  loginModal.classList.remove('hidden');

  setTimeout(() => {
    loginModal.classList.add('opacity-100');
    loginBox.classList.remove('scale-95', 'opacity-0');
    loginBox.classList.add('scale-100', 'opacity-100');
  }, 10);
}

function hideLoginModal() {
  loginModal.classList.remove('opacity-100');
  loginBox.classList.remove('scale-100', 'opacity-100');
  loginBox.classList.add('scale-95', 'opacity-0');

  setTimeout(() => {
    loginModal.classList.add('hidden');
  }, 300);
}



// Pulsar Enter en email o password → hace login
  document.getElementById('loginEmail').addEventListener('keydown', handleEnterKey);
  document.getElementById('loginPassword').addEventListener('keydown', handleEnterKey);

  function handleEnterKey(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      document.getElementById('loginSubmit').click(); // Simula clic en el botón
    }
  }
  
  // Pulsar "Salir" → cierra el modal
  document.getElementById('logoutButton').addEventListener('click', () => {
    const modal = document.getElementById('loginModal');
    const box = document.getElementById('loginBox');

    // Animación de salida si usas clases .opacity-100
    modal.classList.remove('opacity-100');
    box.classList.remove('opacity-100');

    // Opcional: esperar animación antes de ocultar
    setTimeout(() => {
      modal.classList.add('hidden');
    }, 300); // coincide con transition duration
  });
  
  async function loadGames() {
  const snap = await db.collection("games").get();
  const gamesContainer = document.getElementById("games-container");
  gamesContainer.innerHTML = ""; // Limpia antes de insertar

  snap.forEach(doc => {
    const game = doc.data();
    const card = document.createElement("a");
    card.className = "mx-auto my-1 w-[176px]";
    card.href = "#";
    card.target = "_blank";

    card.innerHTML = `
      <div class="text-card-foreground rounded-xl border shadow-md p-2 duration-200 ease-in-out bg-platinum hover:bg-platinum/50">
        <div class="flex flex-col space-y-1.5 p-0">
          <div class="flex flex-col">
            <div class="grid h-[158px]">
              <div class="col-start-1 row-start-1 w-full self-center" style="height: 158px;">
                <img alt="${game.title}" class="rounded-md text-center bg-primary/10 object-cover w-full h-full" src="${game.imageUrl}" style="color: transparent;" />
              </div>
            </div>
            <div class="mt-2 truncate text-sm font-medium text-center" title="${game.title}">${game.title}</div>
          </div>
        </div>
        <div class="pt-1">
          <div class="flex justify-center items-center bg-black text-white text-xs font-medium rounded-full h-4">
            <span class="px-2">${game.cost ? game.cost + " €" : "—"}</span>
          </div>
        </div>
      </div>
    `;
    gamesContainer.appendChild(card);
  });
}

const minDate = '1970-01-01';

  function getTodayISOInSpain() {
    const now = new Date();
    const offset = now.getTimezoneOffset() * 60000;
    const spainTime = new Date(now.getTime() + offset + (2 * 60 * 60000));
    const year = spainTime.getFullYear();
    const month = String(spainTime.getMonth() + 1).padStart(2, '0');
    const day = String(spainTime.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  const todayISO = getTodayISOInSpain();

  // Función para actualizar los atributos type, min y max
  function updateDateInputAttributes(inputElement) {
    inputElement.type = 'date';
    inputElement.min = minDate;
    inputElement.max = todayISO;
  }

  // Event listeners para cambiar el tipo a 'date' al enfocar y establecer min/max
  purchaseDateInput.addEventListener('focus', function() {
    updateDateInputAttributes(this);
  });

  releaseDateInput.addEventListener('focus', function() {
    updateDateInputAttributes(this);
  });

  // Event listeners para volver a 'text' si está vacío al perder el foco
  purchaseDateInput.addEventListener('blur', function() {
    if (!this.value) {
      this.type = 'text';
    }
  });

  releaseDateInput.addEventListener('blur', function() {
    if (!this.value) {
      this.type = 'text';
    }
  });

  let selectedTypes = new Set();  // Añadir al principio del script

   // --- Ordenación ---


    function showAllGames() {
  // Asegurarse de que se muestran todos los juegos, pero respetando la plataforma seleccionada
  gameCards().forEach(card => {
    const matchesPlatform = selectedPlatforms.size === 0 || Array.from(card.querySelectorAll('svg')).some(svg => selectedPlatforms.has(svg.id));
    card.style.display = matchesPlatform ? 'block' : 'none';
  });
}

function applyCombinedFilters() {
  gameCards().forEach(card => {
    // Filtrar por tipo
    const matchesType = selectedTypes.size === 0 || selectedTypes.has(card.id);
    // Filtrar por plataforma
    const matchesPlatform = selectedPlatforms.size === 0 || Array.from(card.querySelectorAll('svg')).some(svg => selectedPlatforms.has(svg.id));
    
    // Mostrar el juego solo si cumple ambos filtros
    card.style.display = (matchesType && matchesPlatform) ? 'block' : 'none';
  });
}



 
   // --- Sistema de selección del punto ---
   function clearSelections(menuId) {
     const options = document.querySelectorAll(`#${menuId} .block`);
     
     options.forEach(option => {
       option.innerHTML = option.textContent.trim().replace(/^·\s*/, ''); // Quitar el punto
       option.style.fontWeight = 'normal'; // Normalizar la fuente
     });
   }
 
   function selectOption(menuId, optionId) {
     clearSelections(menuId); // Limpiar solo las opciones del menú indicado
 
     const selectedOption = document.getElementById(optionId);
     if (selectedOption) {
       selectedOption.innerHTML = `<strong>·</strong> ${selectedOption.textContent.trim().replace(/^·\s*/, '')}`; // Poner el · en negrita
     }
   }

   function setActiveOption(activeElement, labelText) {
  [optionAll, optionLimited, optionFull].forEach(opt => {
    opt.innerHTML = opt.textContent.trim().replace(/^·\s*/, '');  // Limpiar el punto
  });

  activeElement.innerHTML = `<strong>·</strong> ${labelText}`;
  allButtonLabel.textContent = labelText;
}

// Ajustar posición del menú si se desborda
function adjustPlatformMenuPosition() {
  const menu = platformMenu;
  // Obtener el ancho de la ventana
  const screenWidth = window.innerWidth;
  
  // Si el ancho de la pantalla es menor de 1700px, alinear a la derecha
  if (screenWidth < 1700) {
    // Esto alinea el borde derecho del menú con el borde derecho del botón
    menu.style.right = '0';
    menu.style.left = 'auto'; // Asegura que no haya un left que lo anule
  } else {
    // En pantallas grandes, resetear a la posición por defecto
    menu.style.right = '';
    menu.style.left = '';
  }
}

function closeMenusExcept(openId) {
  ['sort-menu', 'all-menu', 'platform-menu'].forEach(id => {
    const menu = document.getElementById(id);
    if (id !== openId) {
      menu.classList.add('hidden'); // Cerrar menús no seleccionados
      // Restablecer la posición del menú de plataformas
      if (id === 'platform-menu') {
        menu.style.right = '';
        menu.style.left = '';
      }
    }
  });
}

function getFilteredGames() {
  // 1. Empieza con todos los juegos en el orden original
  let filtered = [...originalGamesOrder];

  // 2. Aplica filtro de edición si está activo
  if (selectedEditionType !== 'all') {
    const editionMap = {
      'Básica': 'Básica',
      'Reedición': 'Reedición',
      'Especial': 'Especial'
    };
    const editionFilterValue = editionMap[selectedEditionType];
    if (editionFilterValue) {
      filtered = filtered.filter(game => {
        const edition = game.edition ? game.edition.toLowerCase() : '';
        return edition.includes(editionFilterValue.toLowerCase());
      });
    }
  }

  // 3. Aplica filtro de plataforma si hay alguno seleccionado
  const activePlatforms = selectedPlatforms.filter(p => p !== 'all');
  if (activePlatforms.length > 0) {
    filtered = filtered.filter(game => {
      const platform = game.platform ? game.platform : '';
      return activePlatforms.some(selected => platform.includes(selected));
    });
  }

  // 4. Aplica filtro de búsqueda usando la variable global currentSearchTerm
  if (currentSearchTerm && currentSearchTerm !== '') {
    filtered = filtered.filter(game => game.title.toLowerCase().includes(currentSearchTerm));
  }

  // 5. Aplica ordenación según lo que tengas en el botón de ordenación (puedes reutilizar tu código aquí)
  const currentSortLabel = sortButtonLabel.textContent;
  switch (currentSortLabel) {
    case 'Últimas compras':
      filtered.sort((a, b) => new Date(b.purchaseDate).getTime() - new Date(a.purchaseDate).getTime());
      break;
    case 'Primeras compras':
      filtered.sort((a, b) => new Date(a.purchaseDate).getTime() - new Date(b.purchaseDate).getTime());
      break;
    case 'Alfabético (A-Z)':
      filtered.sort((a, b) => a.title.toLowerCase().localeCompare(b.title.toLowerCase()));
      break;
    case 'Alfabético (Z-A)':
      filtered.sort((a, b) => b.title.toLowerCase().localeCompare(a.title.toLowerCase()));
      break;
    case 'Más nuevos':
      filtered.sort((a, b) => {
        const dateA = new Date(a.releaseDate);
        const dateB = new Date(b.releaseDate);
        if (!a.releaseDate) return 1;
        if (!b.releaseDate) return -1;
        return dateB.getTime() - dateA.getTime();
      });
      break;
    case 'Más antiguos':
      filtered.sort((a, b) => {
        const dateA = new Date(a.releaseDate);
        const dateB = new Date(b.releaseDate);
        if (!a.releaseDate) return -1;
        if (!b.releaseDate) return 1;
        return dateA.getTime() - dateB.getTime();
      });
      break;
    case 'Mayor valor':
      filtered.sort((a, b) => (parseFloat(b.value) || 0) - (parseFloat(a.value) || 0));
      break;
    case 'Menor valor':
      filtered.sort((a, b) => (parseFloat(a.value) || 0) - (parseFloat(b.value) || 0));
      break;
    case 'Mayor coste':
      filtered.sort((a, b) => (parseFloat(b.cost) || 0) - (parseFloat(a.cost) || 0));
      break;
    case 'Menor coste':
      filtered.sort((a, b) => (parseFloat(a.cost) || 0) - (parseFloat(b.cost) || 0));
      break;
    default:
      // Si no hay ordenación específica, no cambiar el orden
      break;
  }

  // 6. Devuelve el array filtrado y ordenado
  return filtered;
}



function filterGamesByPlatform() {
  gameCards().forEach(card => {
    const svgsInCard = card.querySelectorAll('svg');
    const matchesPlatform = selectedPlatforms.size === 0 || Array.from(svgsInCard).some(svg => selectedPlatforms.has(svg.id));
    const matchesType = selectedTypes.size === 0 || selectedTypes.has(card.id);
    const shouldShow = (matchesPlatform && matchesType);
    card.style.display = shouldShow ? 'block' : 'none';
  });
}

function applyFiltersAndReset() {
  currentSearchTerm = ""; // Limpiamos el término de búsqueda
  searchInput.value = "";  // Limpia el texto de la barra de búsqueda

  // Obtener los juegos filtrados y ordenados usando la nueva función
  games = getFilteredGames();


  currentPage = 1;        // Ponemos la página en la 1
  renderGamesPage(currentPage);  // Renderizamos la página 1 con los juegos filtrados
  renderPagination();      // Actualizamos la paginación
  updateCollectionSummary(games); // Actualizamos el resumen con los juegos filtrados
}



 }); // Aquí cerramos el 'DOMContentLoaded'
 






const plusBtn = document.getElementById("plus");
const toggleFormBtn = document.getElementById("toggleForm");
const authStatusBtn = document.getElementById("authStatus");

let isOpen = false;

plusBtn.addEventListener("click", () => {
  isOpen = !isOpen;

  if (isOpen) {
    // Mostrar botones sin hidden, con fade in tras un pequeño delay
    [toggleFormBtn, authStatusBtn].forEach(btn => {
      btn.classList.add("visible");
    });
  } else {
    // Ocultar botones con fade out
    [toggleFormBtn, authStatusBtn].forEach(btn => {
      btn.classList.remove("visible");
    });
  }

  // Cambiar el estado visual del botón plus
  plusBtn.classList.toggle("active", isOpen);
});
// Simula el estado de autenticación (reemplaza por lógica Firebase)
let authStatus = '🔒'; // Cambiar a '🔓' dinámicamente con Firebase Auth

const toggleButton = document.getElementById('toggleForm'); 
const tooltip = document.getElementById('loginTooltip');
const modalOverlay = document.getElementById('modalOverlay');
const formElement = document.getElementById('gameForm');
const guardarSubmitButton = document.getElementById('guardarSubmit');

function positionTooltip() {
  const rect = toggleButton.getBoundingClientRect();
  const tooltipWidth = tooltip.offsetWidth;
  const smallScreenBreakpoint = 600;

  if (window.innerWidth <= smallScreenBreakpoint) {
    // Centrar tooltip respecto al botón, limitar que no salga de pantalla
    const leftPos = Math.min(
  Math.max(
    rect.left + window.scrollX - (tooltipWidth / 2) + (rect.width / 2) - 108,  // <-- aquí sumas 20 para desplazar a la derecha
    8
  ),
  window.innerWidth - tooltipWidth - 8
);

    tooltip.style.left = `${leftPos}px`;
    tooltip.style.right = 'auto';
    tooltip.style.top = `${rect.bottom + window.scrollY + 8}px`;
    tooltip.style.transform = 'none';

    const arrow = tooltip.querySelector('.arrow');
    arrow.style.left = 'calc(50% + 103px)';
    arrow.style.right = 'auto';
    arrow.style.transform = 'rotate(-45deg)';

  } else {
    tooltip.style.left = `${rect.left + window.scrollX - tooltipWidth + rect.width}px`;
    tooltip.style.top = `${rect.bottom + window.scrollY + 8}px`;
    tooltip.style.right = 'auto';
    tooltip.style.transform = 'none';

    const arrow = tooltip.querySelector('.arrow');
    arrow.style.right = '10px';
    arrow.style.left = 'auto';
    arrow.style.transform = 'rotate(-45deg)';
  }
}

// Elemento para mostrar errores de formulario
const formError = document.createElement('div');
formError.className = 'text-red-500 mb-2';
formElement.parentNode.insertBefore(formError, formElement);

function clearForm() {
  document.getElementById('imageUrl').value = '';
  document.getElementById('title').value = '';
  document.getElementById('platform').selectedIndex = 0;
  document.getElementById('folder').selectedIndex = 0;
  document.getElementById('condition').selectedIndex = 0;
  // Resetear las estrellas visualmente (si es necesario)
  highlightStars(-1); // Deselecciona todas las estrellas
  selectedRating = 0; // Resetea la calificación
  document.getElementById('purchaseDate').value = '';
  document.getElementById('releaseDate').value = '';
  document.getElementById('purchaseLocation').value = '';
  document.getElementById('region').value = '';
  document.getElementById('gift').value = '';
  document.getElementById('cost').value = '';
  document.getElementById('value').value = '';
  document.getElementById('edition').selectedIndex = 0;
  document.getElementById('wallapopLink').value = '';
  document.getElementById('vintedLink').value = '';
  document.getElementById('ebayLink').value = '';
  document.getElementById('cex').value = '';
  document.getElementById('cexLink').value = '';
  document.getElementById('details').value = '';
}

toggleButton.addEventListener('click', (e) => {
  e.stopPropagation();
  const currentAuth = document.getElementById("authStatus").textContent;

  // Si el tooltip está visible actualmente, hacer clic en el botón SÓLO debería ocultarlo.
  if (tooltip.classList.contains('visible')) {
    tooltip.classList.remove('visible'); // Esto activará el fade-out.
  } else {
    // Si el tooltip NO está visible, entonces proceder con la lógica original:
    // mostrar modal si está autenticado, o mostrar tooltip si no está autenticado.
    if (currentAuth === '🔓') {
      // Mostrar modal con animación
      modalOverlay.classList.add('flex');
      setTimeout(() => {
        modalOverlay.classList.add('opacity-100');
        formElement.classList.add('opacity-100');
      }, 10);
    } else {
      // Mostrar tooltip (esto activará el fade-in ya que no estaba visible antes)
      positionTooltip();
      tooltip.classList.add('visible');
    }
  }
});

// Ocultar al hacer clic fuera
document.addEventListener('click', (e) => {
  const isInsideTooltip = tooltip.contains(e.target) || toggleButton.contains(e.target);
  const isClickOnButton = e.target.tagName === 'BUTTON' || e.target.closest('button');
  const isInsideModal = formElement.contains(e.target);

  // Cerrar tooltip si se hace clic fuera de él
  if (!isInsideTooltip && tooltip.classList.contains('visible')) {
  tooltip.classList.remove('visible');
}

// Cerrar tooltip si se hace clic en cualquier botón (aunque tenga SVG, span, etc.)
if (tooltip.classList.contains('visible') && e.target.closest('button')) {
  tooltip.classList.remove('visible');
}

  // Cerrar modal si se hace clic fuera del formulario

  if (modalOverlay.classList.contains('opacity-100') && !isInsideModal) {
    modalOverlay.classList.remove('opacity-100');
    formElement.classList.remove('opacity-100');
    setTimeout(() => {
      modalOverlay.classList.remove('flex');
    }, 300); // coincide con la duración de animación
  }
});

// Función para mostrar el modal
function showModal() {
  modalOverlay.style.display = 'flex'; // Primero, establecemos display: flex
  modalOverlay.classList.add('opacity-100'); // Luego, iniciamos la transición de opacidad
  gameForm.classList.add('opacity-100'); // Asegúrate de manejar la opacidad del formulario también si es necesario
}

// Función para ocultar el modal
function hideModal() {
  modalOverlay.classList.remove('opacity-100');
  gameForm.classList.remove('opacity-100');
  setTimeout(() => {
    modalOverlay.style.display = 'none'; // Después de la transición, ocultamos el modal
  }, 300); // Espera la duración de la transición (0.3s)
}

// Reposicionar si está visible en resize o scroll
window.addEventListener('resize', () => {
  if (tooltip.classList.contains('visible')) positionTooltip();
});
window.addEventListener('scroll', () => {
  if (tooltip.classList.contains('visible')) positionTooltip();
});

const starsContainer = document.getElementById('estadoStarsContainer');
const stars = document.querySelectorAll('#estadoStars span');
let selectedRating = 0; // Almacena la calificación seleccionada

// Función para resaltar las estrellas hasta un cierto índice
function highlightStars(index) {
  stars.forEach((star, i) => {
    if (i <= index) {
      star.textContent = '★'; // Estrella rellena
      star.classList.add('active');
    } else {
      star.textContent = '☆'; // Estrella vacía
      star.classList.remove('active');
    }
  });
}

// Evento mouseover para resaltar las estrellas al pasar el ratón
starsContainer.addEventListener('mouseover', (e) => {
  if (e.target.tagName === 'SPAN') {
    const hoveredStar = parseInt(e.target.dataset.star);
    highlightStars(hoveredStar - 1); // -1 porque el índice comienza en 0
  }
});

// Evento mouseout para restaurar la selección actual
starsContainer.addEventListener('mouseout', () => {
  highlightStars(selectedRating - 1); // -1 porque el índice comienza en 0
});

// Evento click para almacenar la selección
starsContainer.addEventListener('click', (e) => {
  if (e.target.tagName === 'SPAN') {
    selectedRating = parseInt(e.target.dataset.star);
    highlightStars(selectedRating - 1);
    // Aquí puedes almacenar selectedRating en tu base de datos (Firebase)
    console.log('Calificación seleccionada:', selectedRating);
  }
});

// Inicializar la visualización (opcional, si hay una calificación preseleccionada)
if (selectedRating > 0) {
  highlightStars(selectedRating - 1);
}

window.addEventListener('hashchange', () => {
  const newPage = getPageFromHash() || 1;
  if (newPage !== currentPage) {
    currentPage = newPage;
    localStorage.setItem('currentPage', currentPage);
    renderGamesPage(currentPage);
    renderPagination();
    updateCollectionSummary();
  }
});

  window.addEventListener("DOMContentLoaded", () => {
    document.querySelector(".chart-toggle[data-type='valor']")?.click();
  });
</script>



</body></html>